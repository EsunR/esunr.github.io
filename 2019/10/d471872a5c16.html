<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用 alipay-sdk-nodejs 让 node 应用接入支付宝付款"><meta name="keywords" content="Node,支付宝"><meta name="author" content="EsunR"><meta name="copyright" content="EsunR"><title>使用 alipay-sdk-nodejs 让 node 应用接入支付宝付款 | EsunR-Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?31bd12722efcf47cb7d0d576bf150215";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3RG97DCL3N"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3RG97DCL3N');</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%BC%80%E5%8F%91%E6%9E%84%E6%80%9D"><span class="toc-text">1. 开发构思</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-text">2. 前期准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8"><span class="toc-text">3. 部署应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-alipay-node-sdk-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">3.1 alipay-node-sdk 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA-Sdk-%E5%AE%9E%E4%BE%8B"><span class="toc-text">构建 Sdk 实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#alipaySdk-exec"><span class="toc-text">alipaySdk.exec()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AlipayFormData-addField"><span class="toc-text">AlipayFormData.addField()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Demo"><span class="toc-text">3.2 Demo</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://esunr-webapp.cdn.bcebos.com/blog/avatar.jpeg?x-bce-process=image/resize,m_lfit,w_200/format,f_auto" alt="avatar"></div><div class="author-info__name text-center">EsunR</div><div class="author-info__description text-center">EsunR-Blog是由EsunR维护的博客平台，分享在前端开发、Git、Vue.js、Webpack、OAuth、Linux等各个领域的知识和经验。浏览这里的深入文章，了解不同主题的见解，并及时了解行业的最新趋势和技术。</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/EsunR">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">172</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">155</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">26</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EsunR-Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><span class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></span></span></div><div id="post-info"><div id="post-title">使用 alipay-sdk-nodejs 让 node 应用接入支付宝付款</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/Javascript/">Javascript</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2019/10/d471872a5c16.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2019/10/d471872a5c16.html"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.2k</span><span class="post-meta__separator">|</span><span>Reading time: 9 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-开发构思"><a href="#1-开发构思" class="headerlink" title="1. 开发构思"></a>1. 开发构思</h1><p>我们的总体需求是让 node js 应用接入支付宝，完成用户付款，具体流程是：</p>
<ul>
<li>当用户在商户应用点击付款后，页面跳转到支付宝界面，这时会出现两种情况：<ul>
<li>手机用户唤醒支付宝应用</li>
<li>PC 唤醒支付宝收银台</li>
</ul>
</li>
<li>用户在支付宝页面进行付款，并完成付款</li>
<li>支付宝检测用户完成付款后向商户应用发送一个 POST 请求作为支付完成的异步回调</li>
<li>商户应用对回调信息进行验证后，对订单状态进行变更</li>
<li>用户返回商户应用，刷新订单界面，显示该订单已支付</li>
</ul>
<h1 id="2-前期准备"><a href="#2-前期准备" class="headerlink" title="2. 前期准备"></a>2. 前期准备</h1><p>我们以 Koa 为例，简单演示一下接入支付宝的具体流程，首先安装 Koa 本体以及所需的中间件：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa koa-router koa-static koa-bodyparser -S</span><br></pre></td></tr></table></figure>

<p>之后需要安装阿里官方提供的 nodejs 端的支付宝 sdk：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install alipay-node-sdk -S</span><br></pre></td></tr></table></figure>

<p>当所有的开发依赖准备完成之后，我们可以直接申请应用，同时也可以到支付宝开放平台上使用 <a target="_blank" rel="noopener" href="https://openhome.alipay.com/platform/appDaily.htm">沙箱环境</a> 来模拟真实应用。在此我们以沙箱环境进行开发演示，在沙箱界面需要记住 <strong>APPID</strong>：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pLmxvbGkubmV0LzIwMTkvMTAvMjIvaTdWaGUxY3B3MkFiTFBZLnBuZw?x-oss-process=image/format,png" alt="image.png"><br>同时点击下方的 RSA2 密钥，并下载密钥生成工具，分别生成私钥和公钥。我们要将生成的 <strong>应用私钥</strong> 记录下来，存放到 <code>private-key.pem</code> 文件中；之后再将 “应用公钥” 填写到页面中，从而会生成一个 <strong>支付宝公钥</strong> ，记录该公钥到 <code>public-key.pem</code> 文件中，前期准备工作完成。如果还不清楚以上流程，参考 <a target="_blank" rel="noopener" href="https://docs.open.alipay.com/291/105971#LDsXr">说明文档</a>。</p>
<p>我们来整理一下文件，将密钥文件整理在一起，这样前期准备工作就完成了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── package.<span class="property">json</span></span><br><span class="line">├── package-lock.<span class="property">json</span></span><br><span class="line">├── serve.<span class="property">js</span> <span class="comment">// 主服务</span></span><br><span class="line">└── <span class="keyword">static</span></span><br><span class="line">    ├── index.<span class="property">html</span> <span class="comment">// 客户端</span></span><br><span class="line">    └── pem <span class="comment">// 密钥存放文件夹</span></span><br><span class="line">        ├── private-key.<span class="property">pem</span></span><br><span class="line">        └── public-key.<span class="property">pem</span></span><br></pre></td></tr></table></figure>

<h1 id="3-部署应用"><a href="#3-部署应用" class="headerlink" title="3. 部署应用"></a>3. 部署应用</h1><h2 id="3-1-alipay-node-sdk-的使用"><a href="#3-1-alipay-node-sdk-的使用" class="headerlink" title="3.1 alipay-node-sdk 的使用"></a>3.1 alipay-node-sdk 的使用</h2><p>当用户点击付款信按钮，会触发我们服务器上的一个路由条件，在这个路由中，我们的服务器主动向支付宝服务器发送了一个请求，请求中携带着该条支付的信息（如订单号、商品价格等），同时还携带了私钥信息，当支付宝服务器收到该条请求后，会向我们的服务器返回一个付款 url，我们的服务器再将该条 url 信息转发到前端页面上，由前端页面完成跳转逻辑。</p>
<p>而使用 <code>alipay-node-sdk</code> 就简化了我们的服务器向支付宝服务器发送请求信息的这一过程，它会将必要的参数与加密信息处理好，我们只需要传入业务参数就可以了。</p>
<h4 id="构建-Sdk-实例"><a href="#构建-Sdk-实例" class="headerlink" title="构建 Sdk 实例"></a>构建 Sdk 实例</h4><p>当我们引入 <code>alipay-node-sdk</code> 时首先要对其进行实例化以及全局参数的设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">AlipaySdk</span> = <span class="built_in">require</span>(<span class="string">&#x27;alipay-sdk&#x27;</span>).<span class="property">default</span>;</span><br><span class="line"><span class="keyword">const</span> alipaySdk = <span class="keyword">new</span> <span class="title class_">AlipaySdk</span>(&#123;</span><br><span class="line">   <span class="attr">appId</span>: <span class="string">&#x27;2016**********710&#x27;</span>, <span class="comment">// 之前我们所记录的沙箱环境的 sdk</span></span><br><span class="line">   <span class="attr">privateKey</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./static/pem/private-key.pem&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>), <span class="comment">// 传入私钥</span></span><br><span class="line">   <span class="attr">gateway</span>: <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span> <span class="comment">// 沙箱环境的请求网关与正式环境不一样，需要在此更改，如果是使用正式环境则去掉此处的设置</span></span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<h4 id="alipaySdk-exec"><a href="#alipaySdk-exec" class="headerlink" title="alipaySdk.exec()"></a>alipaySdk.exec()</h4><p><code>alipaySdk.exec()</code>  方法可以帮我们简便的发送一个业务请求，在 <a target="_blank" rel="noopener" href="https://docs.open.alipay.com/api_1">支付API文档</a> 中我们可以查看到所有的业务请求列表，我们以发送一个 <a target="_blank" rel="noopener" href="https://docs.open.alipay.com/api_1/alipay.trade.close">统一收单交易关闭接口(alipay.trade.close)</a> 为例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> alipaySdk.<span class="title function_">exec</span>(<span class="string">&#x27;alipay.trade.close&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">notifyUrl</span>: <span class="string">&#x27;http://notify_url&#x27;</span>,</span><br><span class="line">  <span class="attr">appAuthToken</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="comment">// 通过 bizContent 传递请求参数</span></span><br><span class="line">  <span class="attr">bizContent</span>: &#123;</span><br><span class="line">    <span class="attr">tradeNo</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">outTradeNo</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">operatorId</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从官方文档看到，result 包含 tradeNo、outTradeNo 2 个 key</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;tradeNo: %s, outTradeNo: %s&#x27;</span>, result.<span class="property">tradeNo</span>, result.<span class="property">outTradeNo</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是 alipay-sdk-nodejs 官方提供的演示 demo</p>
</blockquote>
<p>这就引出了我们接下来需要用到的两个接口：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/api_1/alipay.trade.wap.pay/">alipay.trade.wap.pay(手机网站支付接口2.0)</a>：用于返回手机端的支付唤起地址</li>
<li><a target="_blank" rel="noopener" href="https://docs.open.alipay.com/api_1/alipay.trade.page.pay/">alipay.trade.page.pay(统一收单下单并支付页面接口)</a>：用于返回 PC 端的支付宝收银台地址</li>
</ul>
<h4 id="AlipayFormData-addField"><a href="#AlipayFormData-addField" class="headerlink" title="AlipayFormData.addField()"></a>AlipayFormData.addField()</h4><p>如果我们按照上述的方式去请求 alipay.trade.wap.pay 以及 alipay.trade.page.pay 两个接口的话是会返回错误信息的。因为这两个接口属于页面类接口，页面类接口默认返回的数据为 html 代码片段。这类接口我们需要创建一个 FormData 去请求，<strong>而不能直接使用 <code>alipaySdk.exec()</code> 传入业务参数</strong>。</p>
<p>Sdk 提供了一个 <code>AlipayFormData</code> 可以方便我们的创建，这里我们以 alipay.trade.page.pay 接口为示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TypeScript</span></span><br><span class="line"><span class="comment">// import AlipayFormData from &#x27;alipay-sdk/lib/form&#x27;; </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AlipayFormData</span> = <span class="built_in">require</span>(<span class="string">&#x27;alipay-sdk/lib/form&#x27;</span>).<span class="property">default</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">AlipayFormData</span>();</span><br><span class="line"><span class="comment">// 调用 setMethod 并传入 get，会返回可以跳转到支付页面的 url，否则返回的是一个表单的 html 片段</span></span><br><span class="line">formData.<span class="title function_">setMethod</span>(<span class="string">&#x27;get&#x27;</span>);</span><br><span class="line"></span><br><span class="line">formData.<span class="title function_">addField</span>(<span class="string">&#x27;notifyUrl&#x27;</span>, <span class="string">&#x27;http://www.com/notify&#x27;</span>); <span class="comment">// 当支付完成后，支付宝主动向我们的服务器发送回调的地址</span></span><br><span class="line">formData.<span class="title function_">addField</span>(<span class="string">&#x27;returnUrl&#x27;</span>, <span class="string">&#x27;http://www.com/return&#x27;</span>); <span class="comment">// 当支付完成后，当前页面跳转的地址</span></span><br><span class="line">formData.<span class="title function_">addField</span>(<span class="string">&#x27;bizContent&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">outTradeNo</span>: <span class="string">&#x27;out_trade_no&#x27;</span>,</span><br><span class="line">  <span class="attr">productCode</span>: <span class="string">&#x27;FAST_INSTANT_TRADE_PAY&#x27;</span>,</span><br><span class="line">  <span class="attr">totalAmount</span>: <span class="string">&#x27;0.01&#x27;</span>,</span><br><span class="line">  <span class="attr">subject</span>: <span class="string">&#x27;商品&#x27;</span>,</span><br><span class="line">  <span class="attr">body</span>: <span class="string">&#x27;商品详情&#x27;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> alipaySdk.<span class="title function_">exec</span>(</span><br><span class="line">  <span class="string">&#x27;alipay.trade.page.pay&#x27;</span>,</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  &#123; <span class="attr">formData</span>: formData &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// result 为可以跳转到支付链接的 url</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure>

<p>在这里要特别注意，支付宝在用户付款完成后，会向我们的服务器发送一条 <strong>POST 方式</strong> 的异步回调，这个回调地址必须是外网可以访问到的，也就是说这一过程我们必须在线上开发。</p>
<h2 id="3-2-Demo"><a href="#3-2-Demo" class="headerlink" title="3.2 Demo"></a>3.2 Demo</h2><p>介绍完了alipay-node-sdk 的使用，那么接下来就上一个完整的示例进行整体的演示，由于上面已经演示了如何请求 alipay.trade.page.pay(统一收单下单并支付页面接口)，那么接下来就演示一下如何请求 alipay.trade.wap.pay(手机网站支付接口2.0) 让用户进行手机支付：</p>
<blockquote>
<p>注意项目必须在线上开发！否则只会跳转到支付宝界面而接收不到支付宝的异步回调！</p>
</blockquote>
<p>整体目录：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── package.json</span><br><span class="line">├── package-lock.json</span><br><span class="line">├── serve.js </span><br><span class="line">└── static</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── pem </span><br><span class="line">        ├── private-key.pem</span><br><span class="line">        └── public-key.pem</span><br></pre></td></tr></table></figure>

<p>serve.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">static</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AlipaySdk</span> = <span class="built_in">require</span>(<span class="string">&#x27;alipay-sdk&#x27;</span>).<span class="property">default</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AlipayFormData</span> = <span class="built_in">require</span>(<span class="string">&#x27;alipay-sdk/lib/form&#x27;</span>).<span class="property">default</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;koa-bodyparser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> staticPath = <span class="string">&#x27;./static&#x27;</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">static</span>(</span><br><span class="line">  path.<span class="title function_">join</span>(__dirname, staticPath)</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">bodyParser</span>())</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/pay&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> alipaySdk = <span class="keyword">new</span> <span class="title class_">AlipaySdk</span>(&#123;</span><br><span class="line">    <span class="attr">appId</span>: <span class="string">&#x27;20161*******6710&#x27;</span>,</span><br><span class="line">    <span class="attr">privateKey</span>: fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./static/pem/private-key.pem&#x27;</span>, <span class="string">&#x27;ascii&#x27;</span>),</span><br><span class="line">    <span class="attr">gateway</span>: <span class="string">&quot;https://openapi.alipaydev.com/gateway.do&quot;</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">AlipayFormData</span>()</span><br><span class="line">  formData.<span class="title function_">setMethod</span>(<span class="string">&quot;get&quot;</span>)</span><br><span class="line">  formData.<span class="title function_">addField</span>(<span class="string">&quot;notifyUrl&quot;</span>, <span class="string">&quot;http://online_serve_url/paycallback&quot;</span>) <span class="comment">// 回调地址必须为当前服务的线上地址！</span></span><br><span class="line">  formData.<span class="title function_">addField</span>(<span class="string">&quot;returnUrl&quot;</span>, <span class="string">&quot;http://online_serve_url/success&quot;</span>)</span><br><span class="line">  formData.<span class="title function_">addField</span>(<span class="string">&quot;bizContent&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">body</span>: <span class="string">&quot;测试商品&quot;</span>,</span><br><span class="line">    <span class="attr">subject</span>: <span class="string">&quot;女装&quot;</span>,</span><br><span class="line">    <span class="attr">outTradeNo</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">valueOf</span>(),</span><br><span class="line">    <span class="attr">totalAmount</span>: <span class="string">&quot;88.88&quot;</span>,</span><br><span class="line">    <span class="attr">quitUrl</span>: <span class="string">&quot;http://www.taobao.com/product/113714.html&quot;</span>,</span><br><span class="line">    <span class="attr">productCode</span>: <span class="string">&quot;QUICK_WAP_WAY&quot;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> alipaySdk.<span class="title function_">exec</span>(<span class="string">&quot;alipay.trade.wap.pay&quot;</span>, &#123;&#125;, &#123;</span><br><span class="line">    <span class="attr">formData</span>: formData,</span><br><span class="line">    <span class="attr">validateSign</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  ctx.<span class="property">body</span> = result</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/paycallback&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> postData = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;触发付款&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (postData.<span class="property">trade_status</span> === <span class="string">&quot;TRADE_SUCCESS&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> data = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 订单信息</span></span><br><span class="line">  	<span class="comment">// ========= 由请求体内的订单信息，在这里进行数据库中订单状态的更改 ============</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;支付完成！&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/success&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">&quot;支付成功&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">9090</span>)</span><br></pre></td></tr></table></figure>

<p>index.html：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">let</span> oPay = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#pay&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      oPay.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        axios.<span class="title function_">get</span>(<span class="string">&#x27;http://47.106.226.190:9090/pay&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">window</span>.<span class="title function_">open</span>(res.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;pay&quot;</span>&gt;</span>创建付款<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;form&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS：接收到支付宝的异步回调之后，还需要进行异步回调的验签，以保证回调是由支付宝发送的，这个目前还没有研究出来，等研究出来再更新吧。</p>
</blockquote>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Node/">Node</a><a class="post-meta__tags" href="/tags/%E6%94%AF%E4%BB%98%E5%AE%9D/">支付宝</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62c7f2684e36ba34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/10/cef4048cec54.html"><i class="fa fa-chevron-left">  </i><span>Vue 中销毁 keep-alive 缓存组件及缓存组件的管理</span></a></div><div class="next-post pull-right"><a href="/2019/10/add096f5a3ff.html"><span>2019年GoWeb三款主流框架：Gin、Beego、Iris选型对比</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.esunr.site/2019/10/d471872a5c16.html';
  this.page.identifier = '2019/10/d471872a5c16.html';
  this.page.title = '使用 alipay-sdk-nodejs 让 node 应用接入支付宝付款';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'esunr-blog' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://esunr-blog.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By EsunR</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>