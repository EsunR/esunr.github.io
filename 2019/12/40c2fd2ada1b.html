<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="React 开发框架 —— Umi 与 Dva 的快速使用指南"><meta name="keywords" content="React"><meta name="author" content="EsunR"><meta name="copyright" content="EsunR"><title>React 开发框架 —— Umi 与 Dva 的快速使用指南 | EsunR-Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?31bd12722efcf47cb7d0d576bf150215";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3RG97DCL3N"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3RG97DCL3N');</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-UMI"><span class="toc-text">1. UMI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8"><span class="toc-text">1.1 快速使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%96%87%E4%BB%B6%E7%BA%A6%E5%AE%9A"><span class="toc-text">1.2 文件约定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E8%B7%AF%E7%94%B1"><span class="toc-text">1.3 路由</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-DVA"><span class="toc-text">2. DVA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%BC%80%E5%90%AF-DVA"><span class="toc-text">2.1 开启 DVA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA-Model-%E5%B1%82-%EF%BC%88State%EF%BC%89"><span class="toc-text">2.2 创建 Model 层 （State）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E8%BF%9E%E6%8E%A5-Model-%E5%88%B0%E7%BB%84%E4%BB%B6%E4%B8%AD-%EF%BC%88connect%EF%BC%89"><span class="toc-text">2.3 连接 Model 到组件中 （connect）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E4%BF%AE%E6%94%B9-Model-%E5%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE-%EF%BC%88Reducer%EF%BC%89"><span class="toc-text">2.4 修改 Model 层的数据 （Reducer）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E4%BD%BF%E7%94%A8-mapStateToProps-%E4%B8%8E-mapDispatchToProps"><span class="toc-text">2.5 使用 mapStateToProps 与 mapDispatchToProps</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">2.6 异步数据的处理</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://esunr-webapp.cdn.bcebos.com/blog/avatar.jpeg?x-bce-process=image/resize,m_lfit,w_200/format,f_auto" alt="avatar"></div><div class="author-info__name text-center">EsunR</div><div class="author-info__description text-center">EsunR-Blog是由EsunR维护的博客平台，分享在前端开发、Git、Vue.js、Webpack、OAuth、Linux等各个领域的知识和经验。浏览这里的深入文章，了解不同主题的见解，并及时了解行业的最新趋势和技术。</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/EsunR">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">170</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">151</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">25</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EsunR-Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><span class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></span></span></div><div id="post-info"><div id="post-title">React 开发框架 —— Umi 与 Dva 的快速使用指南</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/React/">React</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2019/12/40c2fd2ada1b.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2019/12/40c2fd2ada1b.html"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2.1k</span><span class="post-meta__separator">|</span><span>Reading time: 8 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-UMI"><a href="#1-UMI" class="headerlink" title="1. UMI"></a>1. UMI</h1><blockquote>
<p>umi 可以简单地理解为 roadhog + 路由，思路类似 next.js/nuxt.js，辅以一套插件机制，目的是通过框架的方式简化 React 开发</p>
</blockquote>
<h2 id="1-1-快速使用"><a href="#1-1-快速使用" class="headerlink" title="1.1 快速使用"></a>1.1 快速使用</h2><p>安装 umi：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add global umi</span><br></pre></td></tr></table></figure>

<p>快速创建一个项目：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> umi-demo &amp;&amp; <span class="built_in">cd</span> umi-demo</span><br><span class="line">yarn create umi</span><br><span class="line">yarn <span class="comment"># 安装依赖</span></span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn start</span><br></pre></td></tr></table></figure>

<h2 id="1-2-文件约定"><a href="#1-2-文件约定" class="headerlink" title="1.2 文件约定"></a>1.2 文件约定</h2><p>umi 会在每次构建时根据文件规范自动生成路由，文件约定如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── dist/                          // 默认的 build 输出目录</span><br><span class="line">├── mock/                          // mock 文件所在目录，基于 express</span><br><span class="line">├── config/</span><br><span class="line">    ├── config.js                  // umi 配置，同 .umirc.js，二选一</span><br><span class="line">└── src/                           // 源码目录，可选</span><br><span class="line">    ├── layouts/index.js           // 全局布局</span><br><span class="line">    ├── pages/                     // 页面目录，里面的文件即路由</span><br><span class="line">        ├── .umi/                  // dev 临时目录，需添加到 .gitignore</span><br><span class="line">        ├── .umi-production/       // build 临时目录，会自动删除</span><br><span class="line">        ├── document.ejs           // HTML 模板</span><br><span class="line">        ├── 404.js                 // 404 页面</span><br><span class="line">        ├── page1.js               // 页面 1，任意命名，导出 react 组件</span><br><span class="line">        ├── page1.test.js          // 用例文件，umi test 会匹配所有 .test.js 和 .e2e.js 结尾的文件</span><br><span class="line">        └── page2.js               // 页面 2，任意命名</span><br><span class="line">    ├── global.css                 // 约定的全局样式文件，自动引入，也可以用 global.less</span><br><span class="line">    ├── global.js                  // 可以在这里加入 polyfill</span><br><span class="line">    ├── app.js                     // 运行时配置文件</span><br><span class="line">├── .umirc.js                      // umi 配置，同 config/config.js，二选一</span><br><span class="line">├── .env                           // 环境变量</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>



<h2 id="1-3-路由"><a href="#1-3-路由" class="headerlink" title="1.3 路由"></a>1.3 路由</h2><p>umi 的核心在于组织路由，只要创建的文件符合规范就可以自动生成路由。</p>
<p>详情请查询 <a target="_blank" rel="noopener" href="https://umijs.org/zh/guide/router.html#%E7%BA%A6%E5%AE%9A%E5%BC%8F%E8%B7%AF%E7%94%B1">官方文档</a></p>
<p>首先要创建应用的基础样式，文件存放于 <code>/src/layouts</code> 路径下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入 css module</span></span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">BasicLayout</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.normal&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span> <span class="attr">className</span>=<span class="string">&#123;styles.title&#125;</span>&gt;</span>Yay! Welcome to umi!<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;props.children&#125; &#123;/*插入子路由*/&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">BasicLayout</span>;</span><br></pre></td></tr></table></figure>

<p>单个页面的样式可以在 <code>/src/pages</code> 下创建，如我们想要访问 <code>http://yourwebsite.com/list</code> 就在 <code>pages</code> 文件夹下创建一个 <code>list</code> 目录，以及一个 <code>index.js</code> 文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>list<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面之间的跳转可以引入 <code>Link</code> 声明式路由组件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Link</span> <span class="keyword">from</span> <span class="string">&#x27;umi/link&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/list&quot;</span>&gt;</span>Go to list page<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>同时还可以引入 <code>router</code> 方法来进行命令式导航：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;umi/router&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">backHome</span>(<span class="params"></span>) &#123;</span><br><span class="line">  router.<span class="title function_">push</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&#123;styles.btn&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;backHome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      List</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="2-DVA"><a href="#2-DVA" class="headerlink" title="2. DVA"></a>2. DVA</h1><blockquote>
<p>dva 目前是纯粹的数据流，和 umi 以及 roadhog 之间并没有相互的依赖关系，可以分开使用也可以一起使用</p>
</blockquote>
<p><img src="http://img.cdn.esunr.xyz/markdown/20191207152816.png" alt="Dva 中的数据流"></p>
<h2 id="2-1-开启-DVA"><a href="#2-1-开启-DVA" class="headerlink" title="2.1 开启 DVA"></a>2.1 开启 DVA</h2><p>dva 是基于 redux redux-saga 和 react-router 的轻量级前端框架。</p>
<p>umi 对 dva 进行了整合，可以直接在配置文件 <code>config.js</code> 设置引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    [<span class="string">&#x27;umi-plugin-react&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">dva</span>: <span class="literal">true</span></span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-创建-Model-层-（State）"><a href="#2-2-创建-Model-层-（State）" class="headerlink" title="2.2 创建 Model 层 （State）"></a>2.2 创建 Model 层 （State）</h2><blockquote>
<p>dva 通过 model 的概念把一个领域的模型管理起来，包含同步更新 state 的 reducers，处理异步逻辑的 effects，订阅数据源的 subscriptions 。</p>
</blockquote>
<p><img src="http://img.cdn.esunr.xyz/markdown/20191206184557.png" alt="数据分层的概念"></p>
<p>按照 UMI 规范，我们应该在 <code>/src/models</code> 下创建 Model 层的数据，每个数据层单独存放在一个 <code>.js</code> 文件下，并拥有一个独立的 namespace 进行区分，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">data</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    <span class="attr">maxNum</span>: <span class="number">3</span>, </span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-连接-Model-到组件中-（connect）"><a href="#2-3-连接-Model-到组件中-（connect）" class="headerlink" title="2.3 连接 Model 到组件中 （connect）"></a>2.3 连接 Model 到组件中 （connect）</h2><blockquote>
<p><code>connect</code> 方法继承与 React-Redux</p>
</blockquote>
<p>有了 Model 层的数据之后，我们就不需要在组件内使用 state 来存放数据。调用 Model 层的数据首先需要从 <code>dva</code> 引入 <code>content</code> 装饰器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;dva&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>之后按照命名空间，来讲数据作为组件的 <code>props</code> 传入组件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">connect</span>(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">data</span>: state[namespace].<span class="property">data</span>,</span><br><span class="line">    <span class="attr">maxNum</span>: state[namespace].<span class="property">maxNum</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">List</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在组件内对数据进行调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">data</span>);</span><br></pre></td></tr></table></figure>

<p>除此之外可以按照传统的用法而不使用装饰器用法，使用 <code>connect</code> 方法将组件与 state 数据关联，注意这样做的话，当前返回的不是组件，而是 <code>connect</code> 方法的返回值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">connect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="comment">/* ... ... */</span> &#125;</span><br><span class="line">&#125;)(<span class="title class_">List</span>)</span><br></pre></td></tr></table></figure>

<h2 id="2-4-修改-Model-层的数据-（Reducer）"><a href="#2-4-修改-Model-层的数据-（Reducer）" class="headerlink" title="2.4 修改 Model 层的数据 （Reducer）"></a>2.4 修改 Model 层的数据 （Reducer）</h2><p><img src="http://img.cdn.esunr.xyz/markdown/20191207164324.png" alt="同步数据的数据流图"></p>
<p>首先要在 Model 层设置一个 Reducer 函数，一个 Reducer 函数接收两个参数，分别为 state 和 action。可以用来直接修改 state 中的数据。</p>
<blockquote>
<p>Reducer 函数返回一个新的 state 来与原来的 state 进行 <strong>覆盖操作</strong>，也就是说如果返回的 state 如果缺少某一项，会导致数据丢失。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// listData.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="attr">addNewData</span>: <span class="keyword">function</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> maxNum = state.<span class="property">maxNum</span> + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">let</span> newArr = [...state.<span class="property">data</span>, maxNum];</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">data</span>: newArr,</span><br><span class="line">        maxNum,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>之后在组件中，使用 dva 提供的 <code>connect</code> 装饰器的第二个参数掺入的函数，可以拿到 <code>dispatch</code> 方法，调用 <code>dispatch</code> 方法可以派发一个 <strong>Action</strong> 从而调用一个 <strong>Reducer 函数</strong>，同时要注意结合 namespace 命名空间调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// list.jsx</span></span><br><span class="line">@<span class="title function_">connect</span>(</span><br><span class="line">  <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> action = &#123; </span><br><span class="line">          <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/addNewData`</span> </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">dispatch</span>(action); </span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">List</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置好派发 <code>dispatch</code> 的方法后，方法就被挂载到组件的 <code>props</code> 中了，在组件中调用就可以使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">add</span>()</span><br></pre></td></tr></table></figure>

<h2 id="2-5-使用-mapStateToProps-与-mapDispatchToProps"><a href="#2-5-使用-mapStateToProps-与-mapDispatchToProps" class="headerlink" title="2.5 使用 mapStateToProps 与 mapDispatchToProps"></a>2.5 使用 mapStateToProps 与 mapDispatchToProps</h2><p>两个方法我们可以在外部定义，然后再传入到装饰器内，这样就能更清晰的显示代码调理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// list.jsx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = (<span class="params">state</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">data</span>: state[namespace].<span class="property">data</span>,</span><br><span class="line">    <span class="attr">maxNum</span>: state[namespace].<span class="property">maxNum</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapDispatchToProps</span> = (<span class="params">dispatch</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 派发一个 listData 中的 addNewData 方法</span></span><br><span class="line">      <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/addNewData`</span> &#125;); </span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_">connect</span>( mapStateToProps, mapDispatchToProps )</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">List</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-6-异步数据的处理"><a href="#2-6-异步数据的处理" class="headerlink" title="2.6 异步数据的处理"></a>2.6 异步数据的处理</h2><blockquote>
<p>Dva 的异步能力继承与 Redux-Saga</p>
</blockquote>
<p><img src="http://img.cdn.esunr.xyz/markdown/20191207164413.png" alt="异步数据的数据流图"></p>
<p>Model 对象上的 effect 属性里可以写入 Generator 函数来进行异步数据的获取。创建的 Generator 函数内可以获取到两个参数，分别为 <code>action</code> 和 <code>sagaEffects</code> 对象。</p>
<p>其中 <code>sagaEffects</code> 对象下存在两个方法，<code>call()</code> 方法用于执行异步数据的获取，<code>put()</code> 方法用于派发一个 Action 来更新 state 中的数据。</p>
<p>关于 <code>call()</code> 方法，我们可以不使用 <code>call()</code> 方法而直接去 <code>yield</code> 获取一个异步方法得到的数据，但是按照规范我们必须使用 <code>call()</code> 来包裹一个异步方法，其官方解释如下：</p>
<blockquote>
<p>call 创建了一条描述结果的信息，就像在 Redux 里你使用 action 创建器，创建一个将被 Store 执行的、描述 action 的纯文本对象，call 创建一个纯文本对象描述函数调用。redux-saga middleware 确保执行函数调用并在响应被 resolve 时恢复 generator。这让你能容易地测试 Generator，就算它在 Redux 环境之外。因为 call 只是一个返回纯文本对象的函数而已。</p>
</blockquote>
<p>UMI 为开发者很好的提供了一个 mock 环境，可以直接在项目的 <code>/mock/</code> 路径下创建 js 文件写入 mock 数据，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mockListData.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="string">&#x27;get /api/list&#x27;</span>: <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">listData</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">      <span class="attr">maxNum</span>: <span class="number">4</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有了数据流之后，就可以使用 AJAX 来获取数据。在 <code>effects</code> 中我们来编写一个 Generator 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">&#x27;../utils/request&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">namespace</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="comment">// ... ...</span></span><br><span class="line">    <span class="title function_">addNewData</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (action.<span class="property">payload</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> newState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state));</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(newState, action.<span class="property">payload</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">effects</span>: &#123;</span><br><span class="line">    *<span class="title function_">fetchData</span>(<span class="params">action, &#123; call, put &#125;</span>) &#123;</span><br><span class="line">      <span class="comment">// request 是从外部引入的 XHR 封装的方法</span></span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">yield</span> <span class="title function_">call</span>(request, <span class="string">&#x27;/api/list&#x27;</span>, &#123; <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span> &#125;);</span><br><span class="line">      <span class="comment">// 使用 put() 方法来派发一个 action</span></span><br><span class="line">      <span class="keyword">yield</span> <span class="title function_">put</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;addNewData&#x27;</span>,</span><br><span class="line">        <span class="attr">payload</span>: data,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>与 Reducer 函数一样，Effect 函数也可以通过派发一个 Action 来调用，但 Effect 函数不会主动修改 State 中的数据，而是在获取了数据之后另外生成一个 Action 来调用直接修改数据的 Reducer 函数。</p>
<blockquote>
<p>Effect 函数只是拦截了 Action 然后进行了数据的转发</p>
</blockquote>
<p>在调用时，我们也需要利用 <code>connect</code> 来获取 <code>dispatch</code> 方法来调用一个 Effect 函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">connect</span>(</span><br><span class="line">  <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ... ...</span></span><br><span class="line">      <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">dispatch</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">`<span class="subst">$&#123;namespace&#125;</span>/fetchData`</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">List</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">fetchData</span>()</span><br></pre></td></tr></table></figure>

</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/React/">React</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62c7f2684e36ba34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/12/b92ba13a43b9.html"><i class="fa fa-chevron-left">  </i><span>PHP 开发环境搭建指引</span></a></div><div class="next-post pull-right"><a href="/2019/12/9a94fb35a3ad.html"><span>Linux指令备忘录</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.esunr.site/2019/12/40c2fd2ada1b.html';
  this.page.identifier = '2019/12/40c2fd2ada1b.html';
  this.page.title = 'React 开发框架 —— Umi 与 Dva 的快速使用指南';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'esunr-blog' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://esunr-blog.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By EsunR</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>