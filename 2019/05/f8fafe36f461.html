<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Vue中的MVVM实现原理简析"><meta name="keywords" content="面试题,源码解析,Vue"><meta name="author" content="EsunR"><meta name="copyright" content="EsunR"><title>Vue中的MVVM实现原理简析 | EsunR-Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?31bd12722efcf47cb7d0d576bf150215";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3RG97DCL3N"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3RG97DCL3N');</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-MVVM"><span class="toc-text">1. MVVM</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Object-defineProperty"><span class="toc-text">2. Object.defineProperty()</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%A6%82%E5%BF%B5"><span class="toc-text">1.1 概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%B1%9E%E6%80%A7%E4%BF%AE%E9%A5%B0%E7%AC%A6"><span class="toc-text">1.2 属性修饰符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-get-%E4%B8%8Eset"><span class="toc-text">1.3 get()与set()</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E5%8A%AB%E6%8C%81"><span class="toc-text">3. 数据劫持</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%95%B0%E6%8D%AE%E4%BB%A3%E7%90%86"><span class="toc-text">4. 数据代理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91"><span class="toc-text">5. 模板编译</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0"><span class="toc-text">6. 数据更新</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.1 发布订阅模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E6%A8%A1%E6%8B%9FVue%E4%B8%AD%E7%9A%84%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-text">6.2 模拟Vue中的发布订阅模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A"><span class="toc-text">7. 数据的双向绑定</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7"><span class="toc-text">8. 计算属性</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://esunr-webapp.cdn.bcebos.com/blog/avatar.jpeg?x-bce-process=image/resize,m_lfit,w_200/format,f_auto" alt="avatar"></div><div class="author-info__name text-center">EsunR</div><div class="author-info__description text-center">EsunR-Blog是由EsunR维护的博客平台，分享在前端开发、Git、Vue.js、Webpack、OAuth、Linux等各个领域的知识和经验。浏览这里的深入文章，了解不同主题的见解，并及时了解行业的最新趋势和技术。</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/EsunR">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">170</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">151</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">25</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EsunR-Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><span class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></span></span></div><div id="post-info"><div id="post-title">Vue中的MVVM实现原理简析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-30</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/Vue/">Vue</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2019/05/f8fafe36f461.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2019/05/f8fafe36f461.html"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.7k</span><span class="post-meta__separator">|</span><span>Reading time: 14 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-MVVM"><a href="#1-MVVM" class="headerlink" title="1. MVVM"></a>1. MVVM</h1><p>angular - 脏值检测</p>
<p>vue - 数据劫持+发布订阅模式（不兼容低版本：因为其依赖于Object.defineProperty）</p>
<p>总体流程图：</p>
<p><img src="http://markdown.img.esunr.xyz/vue%E4%B8%ADMVVM%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B.png" alt=""></p>
<h1 id="2-Object-defineProperty"><a href="#2-Object-defineProperty" class="headerlink" title="2. Object.defineProperty()"></a>2. Object.defineProperty()</h1><h2 id="1-1-概念"><a href="#1-1-概念" class="headerlink" title="1.1 概念"></a>1.1 概念</h2><p><code>Object.defineProperty()</code> 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。定义的这个属性具有使用 <code>Object.defineProperty()</code> 为其附上的特性。</p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object.defineProperty(obj, prop, descriptor)</span><br></pre></td></tr></table></figure>

<p><code>obj</code>：要在其上定义属性的对象。</p>
<p><code>prop</code>：要定义或修改的属性的名称。</p>
<p><code>descriptor</code>：将被定义或修改的属性描述符。</p>
<p>示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123; <span class="attr">age</span>: <span class="number">18</span> &#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">value</span>: <span class="string">&#x27;esunr&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; obj</span><br><span class="line">&lt; &#123; age: 18, name: &quot;esunr&quot; &#125;</span><br></pre></td></tr></table></figure>

<p>但是当我们使用 <code>delete obj.school;</code> 是无法删除属性的，为了实现删除 <code>obj</code> 的 <code>school</code> 属性，我们需要去使用属性修饰符：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  let obj = &#123;&#125;;</span><br><span class="line">  Object.defineProperty(obj, &#x27;school&#x27;, &#123;</span><br><span class="line"><span class="addition">+   configurable: true,</span></span><br><span class="line">    value: &#x27;esunr&#x27;</span><br><span class="line">  &#125;);</span><br><span class="line">  delete obj.school;</span><br><span class="line">  console.log(obj);</span><br></pre></td></tr></table></figure>

<p>但是不是使用 <code>Object.defineProperty()</code> 方法定义的对象属性，可以不受限制任意读写，如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; obj.age = 19;</span><br><span class="line">&lt; 19</span><br><span class="line">&gt; obj</span><br><span class="line">&lt; &#123; age: 19, name: &quot;esunr&quot; &#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-属性修饰符"><a href="#1-2-属性修饰符" class="headerlink" title="1.2 属性修饰符"></a>1.2 属性修饰符</h2><p>在上面的代码中，<code>value</code>、<code>configurable</code> 都属于属性修饰符，使用 <code>Object.defineProperty</code> 时，我们要对每一个值都独立配置这些属性修饰符。</p>
<p><strong>数据描述符和存取描述符均具有</strong>以下可选键值：</p>
<p><code>configurable</code></p>
<p>当且仅当该属性的 configurable 为 true 时，该属性<code>描述符</code>才能够被改变，同时该属性也能从对应的对象上被删除。<strong>默认为 false</strong>。</p>
<p><code>enumerable</code></p>
<p>当且仅当该属性的<code>enumerable</code>为<code>true</code>时，该属性才能够出现在对象的枚举属性中。<strong>默认为 false</strong>。（默认不可使用 <code>for..in</code> 循环）</p>
<p><strong>数据描述符同时具有以下可选键值</strong>：</p>
<p><code>value</code></p>
<p>该属性对应的值。可以是任何有效的 JavaScript 值（数值，对象，函数等）。<strong>默认为 <code>undefined</code></strong>。</p>
<p><code>writable</code></p>
<p>当且仅当该属性的<code>writable</code>为<code>true</code>时，<code>value</code>才能被赋值运算符改变。<strong>默认为 false</strong>。</p>
<p><strong>存取描述符同时具有以下可选键值</strong>：</p>
<h2 id="1-3-get-与set"><a href="#1-3-get-与set" class="headerlink" title="1.3 get()与set()"></a>1.3 get()与set()</h2><p><code>get</code></p>
<p>一个给属性提供 getter 的方法，如果没有 getter 则为 <code>undefined</code>。当访问该属性时，该方法会被执行，方法执行时没有参数传入，但是会传入<code>this</code>对象（由于继承关系，这里的<code>this</code>并不一定是定义该属性的对象）。</p>
<p><strong>默认为 <code>undefined</code></strong>。</p>
<blockquote>
<p>存在 <code>get()</code> 时，不能存在 <code>value</code> 属性</p>
</blockquote>
<p>示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// 获取obj.name的值时会调用get方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;esunr&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; obj.name</span><br><span class="line">&lt; &quot;esunr&quot;</span><br></pre></td></tr></table></figure>

<p><code>set</code></p>
<p>一个给属性提供 setter 的方法，如果没有 setter 则为 <code>undefined</code>。当属性值修改时，触发执行该方法。该方法将接受唯一参数，即该属性新的参数值。</p>
<p><strong>默认为 [<code>undefined</code>]</strong>。</p>
<p>示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;;</span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="title function_">set</span>(<span class="params">val</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(val)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; obj.name = &quot;xiaoming&quot;</span><br><span class="line">&lt; &quot;xiaoming&quot;</span><br></pre></td></tr></table></figure>

<h1 id="3-数据劫持"><a href="#3-数据劫持" class="headerlink" title="3. 数据劫持"></a>3. 数据劫持</h1><p>在使用vue时，我们通常将这样定义一个vm实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;app&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">a</span>: <span class="number">2</span> &#125;</span><br><span class="line">&#125;)  </span><br></pre></td></tr></table></figure>

<p>实际上，Vue在其内部代码中进行了一些操作：</p>
<ol>
<li>将所有vm实例的配置项都转入到变量 <code>$options</code> 中</li>
<li>将配置项 <code>data</code> 中的数据进行劫持，存放到vm实例上的 <code>_data</code> 变量中</li>
</ol>
<p>那么进行数据劫持的这一步就是为了将用户由 <code>data</code> 传入的数据使用 <code>Object.defineProperty()</code> 方法为其每一项数据挂载一个 <code>get()</code> 和 <code>set()</code> 方法，同时如果 <code>data</code> 传入的某一项数据也是一个对象，那么也要在这个对象上面挂载 <code>get()</code> 和 <code>set()</code> 方法。</p>
<p><img src="http://img.cdn.esunr.xyz/markdown/20190529151814.png" alt="20190529151814.png"></p>
<p>我们来实现Mvvm对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Mvvm</span>(<span class="params">option = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$options</span> = option; <span class="comment">// 将所有属性挂载了$options上</span></span><br><span class="line">  <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">_data</span> = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">data</span>;</span><br><span class="line">  <span class="title function_">observe</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// vm.$options</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察对象给对象增加 ObjectDefineProperty</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Observe</span>(<span class="params">data</span>) &#123; <span class="comment">// 这里写我们的主要逻辑</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123; <span class="comment">// 把data属性通过object.defineProperty的方式定义属性</span></span><br><span class="line">    <span class="keyword">let</span> val = data[key];</span><br><span class="line">    <span class="title function_">observe</span>(val); <span class="comment">// 如果val是一个对象，就使用递归再为其添加一个 get()、set()方法</span></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>, <span class="comment">// 可枚举</span></span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> val;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">          <span class="comment">// 如果设置的值和以前一样，就不执行set操作</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          val = newVal; <span class="comment">// 如果以后再获取值的时候，将刚才设置的值再丢回去</span></span><br><span class="line">          <span class="title function_">observe</span>(newVal); <span class="comment">// 如果将数据进行重新赋值后，重新赋值的对象也要添加get()和set()</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">observe</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> data !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observe</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例化一个vm对象：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;app&#x27;</span>,</span><br><span class="line">  <span class="attr">data</span>: &#123; <span class="attr">a</span>: &#123;<span class="attr">a</span>: <span class="number">1</span>&#125; &#125;</span><br><span class="line">&#125;)  </span><br></pre></td></tr></table></figure>

<p>可以看出其数据上都挂载了一个 <code>get()</code> 方法和 <code>set()</code> 方法：</p>
<p><img src="http://img.cdn.esunr.xyz/markdown/20190529155054.png" alt="20190529155054.png"></p>
<h1 id="4-数据代理"><a href="#4-数据代理" class="headerlink" title="4. 数据代理"></a>4. 数据代理</h1><p>在Vue中，我们通过 <code>data</code> 添加的数据不仅挂载到了vm实例的 <code>_data</code> 变量中，同时还挂载到了vm实例本身上，并且在我们正常的使用过程中，更多是去调用vm实例本身来获取数据，而并非 <code>_data</code> ，这时候我们就需要通过数据代理，将 <code>_data</code> 中的数据代理到vm实例上。</p>
<p>我们新增原有的核心代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Mvvm</span>(<span class="params">option = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">$options</span> = option;</span><br><span class="line">  <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">_data</span> = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">data</span>;</span><br><span class="line">  <span class="title function_">observe</span>(data);</span><br><span class="line">  <span class="comment">// 使用this代理_data</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> data)&#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>,key, &#123;</span><br><span class="line">      <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_data</span>[key];</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">newVal</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_data</span>[key] = newVal;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现了Vue的两个特点：</p>
<ol>
<li><p>不能新增不存在的属性，因为新增的属性没有get和set</p>
</li>
<li><p>深度相应，每次赋予一个新对象时会给这个新对象增加数据劫持</p>
</li>
</ol>
<h1 id="5-模板编译"><a href="#5-模板编译" class="headerlink" title="5. 模板编译"></a>5. 模板编译</h1><p>在Vue中，我们在文档节点中使用  `{{}}`  来将vm中的数据渲染到文档中，这就需要有一个模板编译方法来处理文档节点中的文本，来解析并且读取数据</p>
<p>新增一个Compile对象来执行编译，其包含两个参数，一个el为MVVM模式下的文档范围，vm为MVVM实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Compile</span>(<span class="params">el, vm</span>) &#123;</span><br><span class="line">  <span class="comment">// el 表示替换的范围</span></span><br><span class="line">  vm.<span class="property">$el</span> = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(el);</span><br><span class="line">  <span class="keyword">let</span> fragment = <span class="variable language_">document</span>.<span class="title function_">createDocumentFragment</span>();</span><br><span class="line">  <span class="keyword">while</span> (child = vm.<span class="property">$el</span>.<span class="property">firstChild</span>) &#123;</span><br><span class="line">    <span class="comment">// 将#app中的内容存放到fragment中，存放入内存等待处理</span></span><br><span class="line">    fragment.<span class="title function_">appendChild</span>(child);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换处理fragment中的文本内容（模拟Vue的模板引擎）</span></span><br><span class="line">  <span class="title function_">replace</span>(fragment)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replace</span>(<span class="params">fragment</span>) &#123;</span><br><span class="line">    <span class="comment">// Array.from() 方法从一个类似数组或可迭代对象中创建一个新的数组实例。</span></span><br><span class="line">    <span class="comment">// 遍历每个fragment中存放的节点</span></span><br><span class="line">    <span class="title class_">Array</span>.<span class="title function_">from</span>(fragment.<span class="property">childNodes</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">node</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> text = node.<span class="property">textContent</span>;</span><br><span class="line">      <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>;</span><br><span class="line">      <span class="comment">// 如果当前的节点类型是3（文本节点），就对其进行匹配处理</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">nodeType</span> === <span class="number">3</span> &amp;&amp; reg.<span class="title function_">test</span>(text)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">RegExp</span>.<span class="property">$1</span>);</span><br><span class="line">        <span class="keyword">let</span> arr = <span class="title class_">RegExp</span>.<span class="property">$1</span>.<span class="title function_">split</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">let</span> val = vm;</span><br><span class="line">        arr.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">k</span>) &#123;</span><br><span class="line">          val = val[k];</span><br><span class="line">        &#125;);</span><br><span class="line">        node.<span class="property">textContent</span> = text.<span class="title function_">replace</span>(<span class="regexp">/\&#123;\&#123;(.*)\&#125;\&#125;/</span>, val);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 如果当前节点不是根节点，就利用递归去深度遍历其内部节点（注意：普通Element节点的根节点都为文本节点）</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">childNodes</span>) &#123;</span><br><span class="line">        <span class="title function_">replace</span>(node);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将内存中的dom节点重新加载到页面中（不需要渲染）</span></span><br><span class="line">  vm.<span class="property">$el</span>.<span class="title function_">appendChild</span>(fragment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在核心代码中启用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Mvvm</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Compile</span>(options.<span class="property">el</span>, <span class="variable language_">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h1 id="6-数据更新"><a href="#6-数据更新" class="headerlink" title="6. 数据更新"></a>6. 数据更新</h1><p>在Vue中，当vm实例上挂载的数据发生更新时，视图也会随之刷新，他们之间存在着发布订阅关系。</p>
<h2 id="6-1-发布订阅模式"><a href="#6-1-发布订阅模式" class="headerlink" title="6.1 发布订阅模式"></a>6.1 发布订阅模式</h2><p>我们再模拟Vue数据更新机制的时候，需要设计一个发布者的构造函数（Dep）和订阅者的构造函数（Watcher）。</p>
<p>发布者内部存放着一个订阅者队列 <code>subArr</code>，同时其原型上挂载了一个 <code>addSub()</code> 方法用来向订阅者队列中添加订阅者，还有一个 <code>carry()</code> 方法，执行该方法后，会遍历订阅者队列，执行每个订阅者身上挂载的 <code>update()</code> 方法。</p>
<p>每个订阅者内部都传入了一个 <code>fn</code> ，是一个方法函数。同时其原型上挂载了一个 <code>update()</code> 方法，在其方法内部执行了实例化订阅者时传入的方法函数 <code>fn</code>。</p>
<p>当发布者发布事件时，只需要调用挂载在其身上的 <code>carry()</code> 方法，就可以将所有订阅者的 <code>update()</code> 方法执行。</p>
<p><img src="http://img.cdn.esunr.xyz/markdown/20190530111309.png" alt="20190530111309.png"></p>
<p>发布订阅模式的构造如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 构造发布者</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Dep</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subArr</span> = [];</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addSub</span> = <span class="keyword">function</span> (<span class="params">sub</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subArr</span>.<span class="title function_">push</span>(sub);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">carry</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subArr</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">sub</span> =&gt;</span> &#123;</span><br><span class="line">    sub.<span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 构造订阅者</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Watcher</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">fn</span> = fn;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">update</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">fn</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-2-模拟Vue中的发布订阅模式"><a href="#6-2-模拟Vue中的发布订阅模式" class="headerlink" title="6.2 模拟Vue中的发布订阅模式"></a>6.2 模拟Vue中的发布订阅模式</h2><p>在Vue中创建一个发布订阅机制我们需要考虑以下几个问题：</p>
<ul>
<li>在哪里创建订阅者 （实例化一个Watcher对象）</li>
<li>在哪里创建发布者 （实例化一个Dep对象）</li>
<li>在哪里添加订阅 （执行发布者的 <code>addSub()</code> 方法）</li>
<li>在哪里发布事件 （执行发布者的 <code>carry()</code> 方法）</li>
</ul>
<blockquote>
<p>每一个渲染出的文本节点对应一个订阅者，一旦发生了数据更新，所有的订阅者的update方法都会被执行，也就是说所有需要解析的文本节点都会被渲染。</p>
</blockquote>
<p>Vue数据更新机制的订阅者是 <code>Compile</code> 编译器，当数据发生了变更时，编译器需要对模板重新编译渲染。在编译器中，执行了模板替换的方法语句是 <code>node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, val);</code> ，那么我们再创建订阅者时，传入其内部的方法就是这条语句：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">  function Compile(el, vm) &#123;</span><br><span class="line">    ... ...</span><br><span class="line"></span><br><span class="line">    // 替换处理fragment中的文本内容（模拟Vue的模板引擎）</span><br><span class="line">    replace(fragment)</span><br><span class="line"></span><br><span class="line">    function replace(fragment) &#123;</span><br><span class="line">      Array.from(fragment.childNodes).forEach(function (node) &#123;</span><br><span class="line">        ... ...</span><br><span class="line">        if (node.nodeType <span class="comment">=== 3 &amp;&amp; reg.test(text)) &#123;</span></span><br><span class="line">          ... ...</span><br><span class="line"><span class="addition">+         new Watcher(function () &#123;</span></span><br><span class="line"><span class="addition">+           node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, val);</span></span><br><span class="line"><span class="addition">+         &#125;)</span></span><br><span class="line">          // 替换的逻辑</span><br><span class="line">          node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, val);</span><br><span class="line">        &#125;</span><br><span class="line">        if (node.childNodes) &#123;</span><br><span class="line">          ... ...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 将内存中的dom节点重新加载到页面中（不需要渲染）</span><br><span class="line">    vm.$el.appendChild(fragment);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这样就达成了一个目的：在页面加载完成后实例化 <code>Compile</code> 时，在执行模板编译的过程中，为每个文本节点对象都渲染出一个订阅者实例，去观察其对应的数据是否变动，如果数据变动，就触发当前文本节点的重新渲染。</p>
<p>我们先不讨论实例化的订阅者何时被调用挂载于其身上的 <code>update()</code> 方法，先假设一旦数据发生了变化，传入订阅者实例的方法就会被执行，即 <code>node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, val)</code> 被执行。但我们会发现，内部参数 <code>val</code> 仍是一个旧值（因为Compile只执行一次，在其内部的变量val肯定是不会动态变更的）。我们在重新渲染文本节点时，需要去将旧文本替换成新文本。</p>
<p>那么问题就是如何获取更新后的新值？</p>
<p>我们需要改动代码，在实例化订阅者对象的时候传入三个值，<code>vm</code> 为Mvvm实例，<code>RegExp.$1</code> 是当前文本节点中匹配的原始待编译字符（也就是  `{{}}` <br> 包裹的内容），第三个参数时传入的执行函数：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- new Watcher(function () &#123;</span></span><br><span class="line"><span class="deletion">-   node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, val);</span></span><br><span class="line"><span class="deletion">- &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+ new Watcher(vm, RegExp.$1, function (newVal) &#123;</span></span><br><span class="line"><span class="addition">+   node.textContent = text.replace(/\&#123;\&#123;(.*)\&#125;\&#125;/, newVal);</span></span><br><span class="line"><span class="addition">+ &#125;)</span></span><br></pre></td></tr></table></figure>

<p>那么传入的这些参数在构造对象 <code>Watcher</code> 中如何使用？</p>
<p>首先我们要接受传入的参数</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  function Watcher(vm, exp, fn) &#123;</span><br><span class="line"><span class="addition">+   this.fn = fn;</span></span><br><span class="line"><span class="addition">+   this.vm = vm;</span></span><br><span class="line"><span class="addition">+   this.exp = exp;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这时候就可以考虑如何将订阅者添加到发布者的 <code>subArr</code> 中了。</p>
<p>首先我们要清楚实例化发布者的位置应该是在 <code>Observe</code> 中，因为其负责了构建每一个数据。所以我们可以去尝试通过访问数据对象上的 <code>get()</code> 方法，来将订阅者添加到其数据上的发布者。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  function Watcher(vm, exp, fn) &#123;</span><br><span class="line">    this.fn = fn;</span><br><span class="line">    this.vm = vm;</span><br><span class="line">    this.exp = exp;</span><br><span class="line"><span class="addition">+   Dep.target = this;</span></span><br><span class="line"><span class="addition">+   let val = vm;</span></span><br><span class="line"><span class="addition">+   let arr = exp.split(&#x27;.&#x27;);</span></span><br><span class="line"><span class="addition">+   arr.forEach(function (k) &#123;</span></span><br><span class="line"><span class="addition">+     val = val[k];</span></span><br><span class="line"><span class="addition">+   &#125;)</span></span><br><span class="line"><span class="addition">+   Dep.target = null;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>Dep.target</code> 是为了存放当前的订阅者对象，在数据的 <code>get()</code> 方法中将订阅者添加到发布者的 <code>subArr</code> 中。 <code>forEach</code> 是为了深度遍历，因为如果当前的数据值是一个对象，那么需要去深度查找这个值中对象的 <code>get()</code> 和 <code>set()</code> 方法。</p>
<p>同样，当数据被重新赋值时，会调用其 <code>set()</code> 方法，所以最终我们在 <code>Observe</code> 中为数据添加 <code>get()</code> 和 <code>set()</code> 方法的代码中要加上如下额外步骤：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  function Observe(data) &#123;</span><br><span class="line"><span class="addition">+   let dep = new Dep();</span></span><br><span class="line">    for (let key in data) &#123;</span><br><span class="line">      let val = data[key];</span><br><span class="line">      observe(val);</span><br><span class="line">      Object.defineProperty(data, key, &#123;</span><br><span class="line">        enumerable: true,</span><br><span class="line">        get() &#123;</span><br><span class="line"><span class="addition">+         Dep.target &amp;&amp; dep.addSub(Dep.target);</span></span><br><span class="line">          return val;</span><br><span class="line">        &#125;,</span><br><span class="line">        set(newVal) &#123;</span><br><span class="line">          if (newVal <span class="comment">=== val) &#123;</span></span><br><span class="line">            return;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            val = newVal;</span><br><span class="line">            observe(newVal);</span><br><span class="line"><span class="addition">+           dep.carry();</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>但是正如最初我们提到的，执行订阅者的 <code>update()</code> 方法去执行传入订阅者内部的函数时，需要获取新值 <code>newVal</code>，那么我们需要去更改一下 <code>update()</code> 方法，由于其执行前已经对数据进行了重新赋值，所以只要查找该订阅者对应的值就可以获取 <code>newVal</code> 了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">update</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> val = <span class="variable language_">this</span>.<span class="property">vm</span>;</span><br><span class="line">  <span class="keyword">let</span> arr = <span class="variable language_">this</span>.<span class="property">exp</span>.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  arr.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">k</span>) &#123;</span><br><span class="line">    val = val[k];</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">fn</span>(val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-数据的双向绑定"><a href="#7-数据的双向绑定" class="headerlink" title="7. 数据的双向绑定"></a>7. 数据的双向绑定</h1><p>为了实现数据的双向绑定，要点在编译模板时，去审查每个Document节点元素身上有没有挂载 <code>v-model</code> 属性，如果有，就获取其 <code>value</code>，为其添加一个订阅，来当数据更新时连带更新输入框的内容，同时添加一个监听方法，当在其内部输入时，触发绑定数据的 <code>set()</code> 方法来变更数据的值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Compile</span>(<span class="params">el, vm</span>) &#123;</span><br><span class="line">  ... ...</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replace</span>(<span class="params">fragment</span>) &#123;</span><br><span class="line">    <span class="title class_">Array</span>.<span class="title function_">from</span>(fragment.<span class="property">childNodes</span>).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">node</span>) &#123;</span><br><span class="line">      ... ...</span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">nodeType</span> === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> nodeAttrs = node.<span class="property">attributes</span>;</span><br><span class="line">        <span class="title class_">Array</span>.<span class="title function_">from</span>(nodeAttrs).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">attr</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> name = attr.<span class="property">name</span>;</span><br><span class="line">          <span class="keyword">let</span> exp = attr.<span class="property">value</span>;</span><br><span class="line">          <span class="comment">// 默认以 &quot;v-&quot; 开头的为 &quot;v-model&quot;</span></span><br><span class="line">          <span class="keyword">if</span> (name.<span class="title function_">indexOf</span>(<span class="string">&#x27;v-&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            node.<span class="property">value</span> = vm[exp];</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, exp, <span class="keyword">function</span> (<span class="params">newVal</span>) &#123;</span><br><span class="line">            node.<span class="property">value</span> = newVal;</span><br><span class="line">          &#125;)</span><br><span class="line">          node.<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> newVal = e.<span class="property">target</span>.<span class="property">value</span>;</span><br><span class="line">            vm[exp] = newVal;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      ... ...</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-计算属性"><a href="#8-计算属性" class="headerlink" title="8. 计算属性"></a>8. 计算属性</h1><p>在Vue中，计算属性可以被缓存到vm实例上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initComputed</span>(<span class="params"></span>) &#123; <span class="comment">// 具有缓存功能</span></span><br><span class="line">  <span class="keyword">let</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">let</span> computed = <span class="variable language_">this</span>.<span class="property">$options</span>.<span class="property">computed</span>;</span><br><span class="line">  <span class="comment">// Object.keys()方法可以将一个对象的key存放在一个数组数组中</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(computed).<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(vm, key, &#123;</span><br><span class="line">      <span class="attr">get</span>: computed[key]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/">面试题</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a><a class="post-meta__tags" href="/tags/Vue/">Vue</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62c7f2684e36ba34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/06/9651226bbace.html"><i class="fa fa-chevron-left">  </i><span>MongoDB快速使用指南</span></a></div><div class="next-post pull-right"><a href="/2019/05/836f15dee62b.html"><span>原生AJAX的使用</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.esunr.site/2019/05/f8fafe36f461.html';
  this.page.identifier = '2019/05/f8fafe36f461.html';
  this.page.title = 'Vue中的MVVM实现原理简析';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'esunr-blog' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://esunr-blog.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By EsunR</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>