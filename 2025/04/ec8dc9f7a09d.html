<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="使用 Mihomo(Clash) 搭建透明网关，使局域网设备科学上网"><meta name="keywords" content="Clash,Mihomo,科学上网"><meta name="author" content="EsunR"><meta name="copyright" content="EsunR"><title>使用 Mihomo(Clash) 搭建透明网关，使局域网设备科学上网 | EsunR-Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?31bd12722efcf47cb7d0d576bf150215";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3RG97DCL3N"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3RG97DCL3N');</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-%E4%BB%80%E4%B9%88%E6%98%AF%E9%80%8F%E6%98%8E%E7%BD%91%E5%85%B3"><span class="toc-text">0. 什么是透明网关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Clash-%E7%AB%AF%E5%BC%80%E5%90%AF-TUN-Mode"><span class="toc-text">1. Clash 端开启 TUN Mode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BD%BF%E7%94%A8-Clash%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">1.1 使用 Clash（不推荐）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BD%BF%E7%94%A8-Mihomo%EF%BC%88%E5%BB%BA%E8%AE%AE%EF%BC%89"><span class="toc-text">1.2 使用 Mihomo（建议）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%BC%80%E5%90%AF%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91"><span class="toc-text">2. 开启流量转发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%AE%8C%E5%85%A8%E6%8B%A6%E6%88%AA%E7%B3%BB%E7%BB%9F-DNS-%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%8D%E5%BB%BA%E8%AE%AE%EF%BC%89"><span class="toc-text">2.1 完全拦截系统 DNS 服务（不建议）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A-systemd-resolved-%E7%9A%84-nameserver%EF%BC%88%E4%B8%8D%E5%BB%BA%E8%AE%AE%EF%BC%89"><span class="toc-text">2.2 手动指定 systemd-resolved 的 nameserver（不建议）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%BC%80%E5%90%AF-Sniffer-%E5%9F%9F%E5%90%8D%E5%97%85%E6%8E%A2%E5%99%A8%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">2.3 开启 Sniffer 域名嗅探器（推荐）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%B7%B2%E7%9F%A5%E9%97%AE%E9%A2%98"><span class="toc-text">3. 已知问题</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://esunr-webapp.cdn.bcebos.com/blog/avatar.jpeg?x-bce-process=image/resize,m_lfit,w_200/format,f_auto" alt="avatar"></div><div class="author-info__name text-center">EsunR</div><div class="author-info__description text-center">EsunR-Blog是由EsunR维护的博客平台，分享在前端开发、Git、Vue.js、Webpack、OAuth、Linux等各个领域的知识和经验。浏览这里的深入文章，了解不同主题的见解，并及时了解行业的最新趋势和技术。</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/EsunR">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">172</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">155</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">26</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EsunR-Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><span class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></span></span></div><div id="post-info"><div id="post-title">使用 Mihomo(Clash) 搭建透明网关，使局域网设备科学上网</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2025-04-08</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%85%B6%E4%BB%96/">其他</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2025/04/ec8dc9f7a09d.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2025/04/ec8dc9f7a09d.html"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><span>Reading time: 11 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>本文只探讨在 Linux 设备下（如树莓派、迷你主机）开启 Clash，并将该设备作为透明网关供家庭其他设备使用这一场景，本文需要一定的网络原理基础。</p>
</blockquote>
<h1 id="0-什么是透明网关"><a href="#0-什么是透明网关" class="headerlink" title="0. 什么是透明网关"></a>0. 什么是透明网关</h1><p>如果一个设备想要科学上网，那么他可以在本机安装代理工具来进行网络访问。但是在一个局域网中，网关是可以自定义的，我们可以将希望科学上网的设备网关指向一台可以转发网络流量的设备，从而让这个设备帮我们把流量转发给代理工具，并让代理工具访问到资源后再返回给设备，这就实现了局域网设备无需安装任何代理工具就能实现科学上网的需求。</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202504081652374.png" alt="image.png|686"></p>
<p>其实“透明网关”和“旁路由”类似，都是非标准术语，只是社区上都这么叫。只是一般我们讲透明网关强调的是数据转发、拦截的功能，而旁路由可能还有 DHCP、NAT 等功能，旁路由安装了 OpenClash 之类的插件也能实现透明网关的功能。</p>
<blockquote>
<p>讲一下为啥不用 OpenClash 来做代理实现同样的功能，因为 OpenClash 设置太复杂了，并且我这边使用的效果会影响局域网内其他设备的网络访问，造成整个局域网都很慢，感觉有很多 BUG。并且 OpenWrt 的资源占用也不低，单纯为了实现透明网关的数据代理不如只用一个轻量的 Linux 系统 + Clash/Mihomo 核心来实现。</p>
</blockquote>
<h1 id="1-Clash-端开启-TUN-Mode"><a href="#1-Clash-端开启-TUN-Mode" class="headerlink" title="1. Clash 端开启 TUN Mode"></a>1. Clash 端开启 TUN Mode</h1><h2 id="1-1-使用-Clash（不推荐）"><a href="#1-1-使用-Clash（不推荐）" class="headerlink" title="1.1 使用 Clash（不推荐）"></a>1.1 使用 Clash（不推荐）</h2><p>安装 Clash permium 版本： <a target="_blank" rel="noopener" href="https://github.com/Dreamacro/clash/releases/tag/premium">https://github.com/Dreamacro/clash/releases/tag/premium</a></p>
<blockquote>
<p>注意：开源的普通版本不支持 TUN Mode，无法搭建透明网关</p>
</blockquote>
<p>Clash 2022 年 3 月的更新在 TUN Mode 的配置中加入了 <code>auto-route</code> 与 <code>auto-detect-interface</code> 两项配置，极大的方便了 Linux 设备开启 TUN 模式，不需要再额外设置 iptables 与 tproxy。</p>
<p>首先在 Clash 配置文件中写入 DNS 与 TUN 配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">listen:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:53</span></span><br><span class="line">  <span class="attr">enhanced-mode:</span> <span class="string">fake-ip</span></span><br><span class="line">  <span class="attr">nameserver:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">223.5</span><span class="number">.5</span><span class="number">.5</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"><span class="attr">tun:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">stack:</span> <span class="string">system</span></span><br><span class="line">  <span class="attr">dns-hijack:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">any:53</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tcp://any:53</span></span><br><span class="line">  <span class="attr">auto-route:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">auto-detect-interface:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>此时再执行 Clash 服务时就已经开启了 TUN Mode。</p>
<h2 id="1-2-使用-Mihomo（建议）"><a href="#1-2-使用-Mihomo（建议）" class="headerlink" title="1.2 使用 Mihomo（建议）"></a>1.2 使用 Mihomo（建议）</h2><p>由于 Clash 作者删库跑路了，Clash.Meta 项目也换了个名字叫 Mihomo 继续维护，因此我们将会使用 Mihomo 来实现透明代理功能。</p>
<p>按照官方教程下载 Mihomo 核心，并将其注册为系统服务：</p>
<ul>
<li>下载：<a target="_blank" rel="noopener" href="https://wiki.metacubex.one/startup/">https://wiki.metacubex.one/startup/</a></li>
<li>注册为系统服务：<a target="_blank" rel="noopener" href="https://wiki.metacubex.one/startup/service/">https://wiki.metacubex.one/startup/service/</a></li>
</ul>
<h1 id="2-开启流量转发"><a href="#2-开启流量转发" class="headerlink" title="2. 开启流量转发"></a>2. 开启流量转发</h1><p>在 Linux 环境下，默认是不转发流量的，也就是说如果将当前设备作为网关，是无法正常上网的。</p>
<p>编辑 /etc/sysctl.conf 文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br></pre></td></tr></table></figure>

<p>将以下代码取消注释</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv6.conf.all.forwarding=1</span><br></pre></td></tr></table></figure>

<p>加载内核参数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<p>然后我们要在想使用透明代理的设备上进行如下设置（以 IOS 为示例）：</p>
<ul>
<li>在 Wifi 详情中，『配置IP』选项选择手动：<ul>
<li>『IP地址』输入一个内网地址，即手动为你的设备分配一个内网 IPv4 的地址；</li>
<li>『子网掩码』输入 255.255.255.0；</li>
<li>『路由器』输入运行 Clash 的设备的内网地址；</li>
</ul>
</li>
<li>选择『配置DNS』为手动，并添加服务器，IP 为当前运行 Clash 的设备的内网地址；</li>
</ul>
<p>按道理来讲的话进行这样的设置后即可让内网设备发送的数据包都被 Clash 进行代理，但是，由于 Linux 环境比较复杂，你可能会出现手机还是无法访问外网的情况，那么就要继续看下去这篇文章了。</p>
<p>开启 TUN Mode 后，可能会遇到 <a target="_blank" rel="noopener" href="https://github.com/Dreamacro/clash/issues/2671"><code>dns-hijack</code> 失败的情况</a>（如 Ubuntu 22），具体的表现为访问 <a target="_blank" rel="noopener" href="http://clash.razord.top/">Clash 控制面板</a> 的日志选项时，会发现所有的域名规则都失效了，请求会直接落到 IP 请求规则上，最后匹配到兜底的 MATCH 规则。</p>
<p>要想搞清楚原因，就要明白在 Linux 系统的 DNS 解析到底经过了什么流程：</p>
<ul>
<li>首先用户对一个域名发起 HTTP 请求前，会首先发起 DNS 解析请求；</li>
<li>Linux 在发起 DNS 解析请求时，会参照 <code>/etc/resolv.conf</code> 文件的配置来进行请求，这个文件中配置了 DNS 解析的服务器、超时时间、传输协议等信息，比如 nameserver 定义了DNS 服务器为 <code>8.8.8.8</code>，那么 DNS 请求就会发送给 <code>8.8.8.8</code> 这个服务器（DNS 请求是一个 UDP 请求，并且访问的是 53 端口）；</li>
<li>DNS 请求完毕，获取到目标 IP；</li>
<li>构建 HTTP 请求报文，才向目标服务器发送请求。</li>
</ul>
<p>但是在常见的 Linux 发行版中，为了优化 DNS 请求（比如缓存 DNS）以及进行一些其他操作，<code>resolv.conf</code> 文件的控制权可能被其他应用拦截，以 Ubuntu 为例，<code>resolv.conf</code> 文件时由 <code>systemd-resolved</code> 控制的，当你去尝试直接修改该配置文件时，就会出现如下警告：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).</span><br><span class="line"># Do not edit.</span><br><span class="line">#</span><br><span class="line"># This file might be symlinked as /etc/resolv.conf. If you&#x27;re looking at</span><br><span class="line"># /etc/resolv.conf and seeing this text, you have followed the symlink.</span><br><span class="line">#</span><br><span class="line"># This is a dynamic resolv.conf file for connecting local clients to the</span><br><span class="line"># internal DNS stub resolver of systemd-resolved. This file lists all</span><br><span class="line"># configured search domains.</span><br><span class="line">#</span><br><span class="line"># Run &quot;resolvectl status&quot; to see details about the uplink DNS servers</span><br><span class="line"># currently in use.</span><br><span class="line">#</span><br><span class="line"># Third party programs should typically not access this file directly, but only</span><br><span class="line"># through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a</span><br><span class="line"># different way, replace this symlink by a static file or a different symlink.</span><br><span class="line">#</span><br><span class="line"># See man:systemd-resolved.service(8) for details about the supported modes of</span><br><span class="line"># operation for /etc/resolv.conf.</span><br></pre></td></tr></table></figure>

<p>这个意思是如果你直接修改了这个文件，那么就会影响到 <code>systemd-resolved</code>，并且你修改了也是没有用的，在服务重启后，<code>systemd-resolved</code> 就会重写这个文件，你做的变更不会被保留下来。</p>
<p>经过 <code>systemd-resolved</code> 的修改，<code>resolv.conf</code> 文件的 <code>nameserver</code> 配置会被设置为 <code>127.0.0.53</code>，可以很容易的发现，这并不是一个线上的 DNS 服务器，而是一个本地 IP，这个就是  <code>systemd-resolved</code> 创建的本地 DNS 解析服务器。如果是在一个局域网中，<code>systemd-resolved</code> 还会把 DNS 服务器的目标地址再转为路由器（网关）的IP。这样就形成了如下的流程：</p>
<ul>
<li>发起 DNS 请求</li>
<li>DNS 请求目标地址为 <code>127.0.0.53:53</code>，即  <code>systemd-resolved</code> 的本地 DNS 服务器</li>
<li>检查本地 DNS 服务器有无缓存，如果没有缓存，转发给路由器（网关）的 DNS 服务器（如 192.168.123.1）</li>
<li>检查网关层有无缓存，如果没有缓存才将请求转发给公网 DNS 服务器，如 <code>114.114.114</code></li>
</ul>
<p>那么 Clash 的 dns-hijack 有一个很重要的特性，就是 <strong>dns-hijack 不会去拦截本地的 DNS 服务器</strong>。我们不难发现，经过 <code>systemd-resolved</code> 的操作，DNS 请求在本机发出请求的目标 IP 为路由器（网关）的IP，这就不难解释为什么 dns-hijack 失效了，因为 Clash 全程都没有拦截到任何一个向公网发出的 DNS 请求，真正的 DNS 请求都交给路由器（网关）处理了。经过处理后的 DNS 请求转化成 IP 之后再发出 HTTP 请求，所以 Clash 拿到的只是一个目标 IP，这也解释了为什么所有的域名规则匹配失败了。</p>
<p>综上，解决这个问题有两个方案：</p>
<h2 id="2-1-完全拦截系统-DNS-服务（不建议）"><a href="#2-1-完全拦截系统-DNS-服务（不建议）" class="headerlink" title="2.1 完全拦截系统 DNS 服务（不建议）"></a>2.1 完全拦截系统 DNS 服务（不建议）</h2><p>简单粗暴，直接禁用 <code>systemd-resolved</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> systemd-resolved</span><br></pre></td></tr></table></figure>

<p>如果还不行就手动在 <code>resolv.conf</code> 文件中将 <code>nameserver</code> 设置为一个外网的 DNS 服务器 IP（如 8.8.8.8），这样 DNS 请求都会被 Clash 的 dns-hijack 拦截，然后返回 fake-ip，执行匹配规则等后续流程。</p>
<p>但这样有个问题，当 Clash 关闭后，这台机子就完全无法联网了，同时，关闭 <code>systemd-resolved</code> 可能会造成一些其他问题（比如桌面端的 Ubuntu 无法正常的显示网络连接图标等）。</p>
<p>那么就需要使用一个侵入性较小的方案</p>
<h2 id="2-2-手动指定-systemd-resolved-的-nameserver（不建议）"><a href="#2-2-手动指定-systemd-resolved-的-nameserver（不建议）" class="headerlink" title="2.2 手动指定 systemd-resolved 的 nameserver（不建议）"></a>2.2 手动指定 systemd-resolved 的 nameserver（不建议）</h2><p>既然 Clash 无法拦截本地 DNS 请求，那就保证 DNS 在网卡发出的请求目标地址不要为路由器（网关）的 IP就可以了，这个通过修改 <code>systemd-resolved</code> 服务的配置文件可以实现。</p>
<p>打开 <code>/etc/systemd/resolved.conf</code> 文件，并修改 nameserver 为任意一个外网 IP，这样 DNS 请求就不会转发给路由器了，而是直接尝试向外网 DNS 服务器发起请求，这样就可以被 Clash 拦截到了~</p>
<p>但此时还有些小问题，如果我们直接请求外网 DNS 服务器，那我们在路由器 host 中配置的本地域名就无法读取到了，我们可以将 Clash 的 DNS 服务器列表中手动加上路由器 IP 来解决。</p>
<p>此时如果使用透明代理的方式，需要将设备的 DNS 修改为任意一个外网 DNS 服务器 IP，<strong>不能设置为 Clash 部署机子的内网 IP 了</strong>，否则还是会导致 Clash 无法拦截 DNS 请求。</p>
<h2 id="2-3-开启-Sniffer-域名嗅探器（推荐）"><a href="#2-3-开启-Sniffer-域名嗅探器（推荐）" class="headerlink" title="2.3 开启 Sniffer 域名嗅探器（推荐）"></a>2.3 开启 Sniffer 域名嗅探器（推荐）</h2><blockquote>
<p>注意只有 mihomo、clash.meta 才有此功能。</p>
</blockquote>
<p>如下是目前一个比较完美的透明网关配置，无需处理 <code>systemd-resolved</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否允许内核接受 IPv6 流量</span></span><br><span class="line"><span class="attr">ipv6:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 允许其他设备经过 Clash 的代理端口</span></span><br><span class="line"><span class="attr">allow-lan:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 开启统一延迟时，会计算 RTT，以消除连接握手等带来的不同类型节点的延迟差异</span></span><br><span class="line"><span class="attr">unified-delay:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># TCP 并发</span></span><br><span class="line"><span class="attr">tcp-concurrent:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 控制是否让 Clash 去匹配进程，设置为 strict，由 Clash 判断是否开启</span></span><br><span class="line"><span class="attr">find-process-mode:</span> <span class="string">strict</span></span><br><span class="line"><span class="comment"># 全局 TLS 指纹，优先低于 proxy 内的 client-fingerprint</span></span><br><span class="line"><span class="attr">global-client-fingerprint:</span> <span class="string">chrome</span></span><br><span class="line"></span><br><span class="line"><span class="attr">profile:</span></span><br><span class="line">  <span class="comment"># 储存 API 对策略组的选择，以供下次启动时使用</span></span><br><span class="line">  <span class="attr">store-selected:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># 储存 fakeip 映射表，域名再次发生连接时，使用原有映射地址</span></span><br><span class="line">  <span class="attr">store-fake-ip:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 域名嗅探：https://wiki.metacubex.one/config/sniff/</span></span><br><span class="line"><span class="comment"># 用于解决流量到达 Clash 时只有 IP 没有域名的问题</span></span><br><span class="line"><span class="attr">sniffer:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sniff:</span></span><br><span class="line">    <span class="attr">HTTP:</span></span><br><span class="line">      <span class="attr">ports:</span> [<span class="number">80</span>, <span class="number">8080</span><span class="number">-8880</span>]</span><br><span class="line">      <span class="attr">override-destination:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">TLS:</span></span><br><span class="line">      <span class="attr">ports:</span> [<span class="number">443</span>, <span class="number">8443</span>]</span><br><span class="line">    <span class="attr">QUIC:</span></span><br><span class="line">      <span class="attr">ports:</span> [<span class="number">443</span>, <span class="number">8443</span>]</span><br><span class="line">  <span class="attr">skip-domain:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;Mijia Cloud&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;+.push.apple.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启虚拟网卡处理流量</span></span><br><span class="line"><span class="attr">tun:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">stack:</span> <span class="string">mixed</span></span><br><span class="line">  <span class="attr">dns-hijack:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;any:53&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;tcp://any:53&quot;</span></span><br><span class="line">  <span class="attr">auto-route:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">auto-redirect:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">auto-detect-interface:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启 Clash 内置的 DNS 服务，嗅探服务需要用到</span></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ipv6:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enhanced-mode:</span> <span class="string">fake-ip</span></span><br><span class="line">  <span class="attr">fake-ip-filter:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;+.lan&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;+.local&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;+.market.xiaomi.com&quot;</span></span><br><span class="line">  <span class="attr">default-nameserver:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tls://223.5.5.5</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">tls://223.6.6.6</span></span><br><span class="line">  <span class="attr">nameserver:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://doh.pub/dns-query</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">https://dns.alidns.com/dns-query</span></span><br></pre></td></tr></table></figure>

<p>这里简单讲一下数据通过 Mihomo/Clash 的流程：</p>
<ol>
<li>局域网设备请求 google.com，发起 DNS 请求；</li>
<li>DNS 请求转发到透明代理层，被 Mihomo 的 DNS 服务拦截，Mihomo 发现使用的是 fake-ip 模式同时启用了域名嗅探，就会生成一个在记录中唯一的虚假 ip 地址提供给局域网设备，并在映射表中记录下 fake-ip 和域名的对应关系；</li>
<li>局域网设备获取到 DNS 返回的 IP 后浏览器向目标 IP 发起请求；</li>
<li>数据包再次来到透明代理，此时透明代理通过数据包只能看到 IP，看不到请求的真实域名，但是由于第二步中记录了 fake-ip 对应的真实域名，因此读取映射表获取真实 IP；</li>
<li>按照 Mihomo 的节点规则配置，进行域名规则匹配，如果匹配到敏感域名则走代理节点。域名无匹配规则时则会发起本地或者远程 DNS 请求（这里不太清楚逻辑）获取真实 IP，再根据 GEOIP 信息选择走节点代理还是走本地流量；</li>
</ol>
<p>这里需要注意：tun、dns、sniffer 是必须配置的，否则会出现网络无法访问、DNS 请求失败、https 证书返回了其他网站的等奇怪的问题。</p>
<p>关于 DNS 劫持、fake-ip、域名嗅探等细节，可以观看视频：<a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=aKlH6KRt9Jc&t=911s&ab_channel=%E4%B8%8D%E8%89%AF%E6%9E%97">https://www.youtube.com/watch?v=aKlH6KRt9Jc&amp;t=911s&amp;ab_channel=%E4%B8%8D%E8%89%AF%E6%9E%97</a></p>
<h1 id="3-已知问题"><a href="#3-已知问题" class="headerlink" title="3. 已知问题"></a>3. 已知问题</h1><p>如果禁用了系统的 dns 服务，会导致在 clash 服务启动之前的所有服务的 dns 查找都崩溃，比如 nginx、frpc 等。解决方法是在 clash 服务启动之后再启动其他的服务。</p>
<p>此外，如果使用了 homeassistant，Homekit 插件也会因为 Clash 对 DNS 的干扰，导致配件无响应。解决方法是先启动 Homeassistant，然后再启动 Clash。</p>
<p>参考教程：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lvv.me/posts/2022/09/12_clash_as_router/">Clash 旁路由透明网关</a></li>
<li><a target="_blank" rel="noopener" href="https://little-star.love/posts/5d083060">https://little-star.love/posts/5d083060</a></li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Clash/">Clash</a><a class="post-meta__tags" href="/tags/Mihomo/">Mihomo</a><a class="post-meta__tags" href="/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/">科学上网</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62c7f2684e36ba34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2025/05/8017c6524211.html"><i class="fa fa-chevron-left">  </i><span>使用 frp + Caddy 实现加密穿透内网服务并支持 HTTPS</span></a></div><div class="next-post pull-right"><a href="/2025/04/9dc9594be9bc.html"><span>HomeLab 家庭服务器折腾日记</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.esunr.site/2025/04/ec8dc9f7a09d.html';
  this.page.identifier = '2025/04/ec8dc9f7a09d.html';
  this.page.title = '使用 Mihomo(Clash) 搭建透明网关，使局域网设备科学上网';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'esunr-blog' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://esunr-blog.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By EsunR</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>