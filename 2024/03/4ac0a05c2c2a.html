<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="html2canvas 图片跨域问题的解决方案及其原理"><meta name="keywords" content="JavaScript,HTML2Canvas,跨域"><meta name="author" content="EsunR"><meta name="copyright" content="EsunR"><title>html2canvas 图片跨域问题的解决方案及其原理 | EsunR-Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?31bd12722efcf47cb7d0d576bf150215";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-3RG97DCL3N"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3RG97DCL3N');</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.2.0'
} </script><meta name="generator" content="Hexo 6.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%89%8D%E8%A8%80"><span class="toc-text">1. 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-html2canvas-%E7%9A%84-allowTaint-%E4%B8%8E-useCORS"><span class="toc-text">2. html2canvas 的 allowTaint 与 useCORS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-allowTaint-%E6%97%B6%E5%85%B7%E4%BD%93%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-text">开启 allowTaint 时具体发生了什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AF-useCORS-%E6%97%B6%E5%85%B7%E4%BD%93%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-text">开启 useCORS 时具体发生了什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#allowTaint-%E5%92%8C-useCORS-%E8%AE%BE%E7%BD%AE%E5%90%8E%E7%9A%84%E5%85%B7%E4%BD%93%E8%A1%A8%E7%8E%B0"><span class="toc-text">allowTaint 和 useCORS 设置后的具体表现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%8F%97%E8%AE%BF%E9%97%AE%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BF%85%E9%A1%BB%E6%94%AF%E6%8C%81-CORS"><span class="toc-text">3. 受访问的服务器必须支持 CORS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E4%B8%BA-img-%E6%A0%87%E7%AD%BE%E6%B7%BB%E5%8A%A0-crossorigin-%E5%B1%9E%E6%80%A7"><span class="toc-text">4. 为 img 标签添加  crossorigin 属性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#corssorigin-%E2%80%9Danonymous%E2%80%9D-%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-text">corssorigin&#x3D;”anonymous” 做了什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E8%AE%BE%E7%BD%AE-corssorigin-%E2%80%9Danonymous%E2%80%9D"><span class="toc-text">为什么要设置 corssorigin&#x3D;”anonymous”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%9D%A5%E8%87%AA%E5%85%B6%E4%BB%96%E9%A1%B5%E9%9D%A2%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-text">5. 来自其他页面的缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A5%E8%87%AA%E5%90%8C%E7%AB%99%E7%82%B9%E7%9A%84%E5%9B%BE%E7%89%87%E7%BC%93%E5%AD%98"><span class="toc-text">来自同站点的图片缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A5%E8%87%AA%E5%90%8C%E5%9F%9F%E7%9A%84%E7%BC%93%E5%AD%98"><span class="toc-text">来自同域的缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-text">解决方案</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://esunr-webapp.cdn.bcebos.com/blog/avatar.jpeg?x-bce-process=image/resize,m_lfit,w_200/format,f_auto" alt="avatar"></div><div class="author-info__name text-center">EsunR</div><div class="author-info__description text-center">EsunR-Blog是由EsunR维护的博客平台，分享在前端开发、Git、Vue.js、Webpack、OAuth、Linux等各个领域的知识和经验。浏览这里的深入文章，了解不同主题的见解，并及时了解行业的最新趋势和技术。</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/EsunR">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">170</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">151</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">25</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">EsunR-Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><span class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></span></span></div><div id="post-info"><div id="post-title">html2canvas 图片跨域问题的解决方案及其原理</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-03-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%89%8D%E7%AB%AF/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2024/03/4ac0a05c2c2a.html#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2024/03/4ac0a05c2c2a.html"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">3.6k</span><span class="post-meta__separator">|</span><span>Reading time: 13 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h1><p>html2canvas 是一个用于将 DOM 结构转为 canvas 对象的一个库，利用这个库就可以实现对页面的某一部分进行截图这样的功能。</p>
<p>但是由于其工作方式是将 DOM 结构进行解析后渲染在一个离屏 canvas 上，因此会受到一些限制。最常见的就是跨域资源无法被正常渲染，其根本原因是 canvas 调用跨域资源时受到 CORS 的保护，为了避免出现跨域资源的问题通常的解决方案是：</p>
<ol>
<li>将 html2canvas 的 <code>useCORS</code> 设置为 <code>true</code>；</li>
<li>受访问的服务器必须支持 CORS，也就是以跨域方式获取资源时要返回对应的跨域头；</li>
<li>为 img 标签添加 <code>crossorigin=&quot;anonymous&quot;</code> 属性；</li>
</ol>
<p>但是如果不搞清楚做的每一个行为具体做了什么事情，会发生什么，那么还是会出现各种各样的问题。</p>
<h1 id="2-html2canvas-的-allowTaint-与-useCORS"><a href="#2-html2canvas-的-allowTaint-与-useCORS" class="headerlink" title="2. html2canvas 的 allowTaint 与 useCORS"></a>2. html2canvas 的 allowTaint 与 useCORS</h1><p>解决方案的第一条『将 html2canvas 的 <code>useCORS</code> 设置为 <code>true</code>』，表示允许 canvas 中加载使用 CORS 加载跨域资源，那么 <code>useCORS</code> 具体做了什么事情？同时 <code>allowTaint</code> 选项也是允许画布被污染（也就是允许加载跨域资源），其与 <code>useCORS</code> 的开关又有什么关系？本章节主要对这两个问题进行讨论。</p>
<h3 id="开启-allowTaint-时具体发生了什么"><a href="#开启-allowTaint-时具体发生了什么" class="headerlink" title="开启 allowTaint 时具体发生了什么"></a>开启 allowTaint 时具体发生了什么</h3><p>我们先谈 <code>allowTaint</code>，这一选项表示是否允许画布被污染（也就是是否允许在画布中加载跨域资源），可能很多人都尝试开启 <code>allowTaint</code> 来加载跨域图片，但却只会得到一个报错，让我们来看看具体发生了什么。</p>
<p><code>allowTaint</code> 默认为 <code>false</code> 时，html2canvas 遇到跨域资源（如跨域图片、跨域画布）时会直接不将此元素绘制到画布上，避免 canvas 在调用 <code>toDataURL</code> 这类操作画布的 API 时报错，比如出现 <code>Tainted canvases may not be exported（受污染的画布不得导出）</code> 的错误。</p>
<p>反之，<code>alowTaint</code> 设置为 <code>true</code> 后，html2canvas 便会跳过检查跨域资源的这一过程，但如果画布确实被污染，调用 <code>toDataURL</code> 等这类操作画布的 API 时就会报错，并且 html2canvas 的 Promise 会走到 catch 阶段。</p>
<p>需要注意的是，对于图片资源只有在 <code>allowTaint</code> 设置为 <code>false</code> ，且没有使用 <code>useCORS</code> 或者 <code>proxy</code> 时，才会不将其绘制到画布上，具体的判断代码如下：</p>
<blockquote>
<p>这也就是 <code>allowTaint</code> 和 <code>useCORS</code> 的关系了</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">async</span> <span class="title function_">loadImage</span>(<span class="params">key: string</span>) &#123;</span><br><span class="line">	<span class="keyword">const</span> isSameOrigin = <span class="title class_">CacheStorage</span>.<span class="title function_">isSameOrigin</span>(key);</span><br><span class="line">	<span class="keyword">const</span> useCORS =</span><br><span class="line">		!<span class="title function_">isInlineImage</span>(key) &amp;&amp; <span class="variable language_">this</span>.<span class="property">_options</span>.<span class="property">useCORS</span> === <span class="literal">true</span> &amp;&amp; <span class="variable constant_">FEATURES</span>.<span class="property">SUPPORT_CORS_IMAGES</span> &amp;&amp; !isSameOrigin;</span><br><span class="line">	<span class="keyword">const</span> useProxy =</span><br><span class="line">		!<span class="title function_">isInlineImage</span>(key) &amp;&amp;</span><br><span class="line">		!isSameOrigin &amp;&amp;</span><br><span class="line">		!<span class="title function_">isBlobImage</span>(key) &amp;&amp;</span><br><span class="line">		<span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">_options</span>.<span class="property">proxy</span> === <span class="string">&#x27;string&#x27;</span> &amp;&amp;</span><br><span class="line">		<span class="variable constant_">FEATURES</span>.<span class="property">SUPPORT_CORS_XHR</span> &amp;&amp;</span><br><span class="line">		!useCORS;</span><br><span class="line">	<span class="keyword">if</span> (</span><br><span class="line">		!isSameOrigin &amp;&amp;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">_options</span>.<span class="property">allowTaint</span> === <span class="literal">false</span> &amp;&amp;</span><br><span class="line">		!<span class="title function_">isInlineImage</span>(key) &amp;&amp;</span><br><span class="line">		!<span class="title function_">isBlobImage</span>(key) &amp;&amp;</span><br><span class="line">		!useProxy &amp;&amp;</span><br><span class="line">		!useCORS</span><br><span class="line">	) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ... ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="开启-useCORS-时具体发生了什么"><a href="#开启-useCORS-时具体发生了什么" class="headerlink" title="开启 useCORS 时具体发生了什么"></a>开启 useCORS 时具体发生了什么</h3><p><code>useCORS</code> 表示是否尝试使用 CORS 从服务器加载图像，默认为 <code>false</code>。当设置为 <code>true</code> 时，html2canvas 将跨域图片绘制到 canvas 上时，会为其添加 <code>crossorigin</code> 属性：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// html2canvas/src/core/cache-storage.ts</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isInlineBase64Image</span>(src) || useCORS) &#123;</span><br><span class="line">	img.<span class="property">crossOrigin</span> = <span class="string">&#x27;anonymous&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">img.<span class="property">src</span> = src;</span><br></pre></td></tr></table></figure>

<p>这样请求的图片就会尝试从服务端获取跨域头，确认安全后，图片就正常渲染在画布上。关于具体的图片请求，与 img 标签设置了 <code>crossorigin=&quot;anonymous&quot;</code> 属性后发起的请求是一致的，具体看后文。</p>
<h3 id="allowTaint-和-useCORS-设置后的具体表现"><a href="#allowTaint-和-useCORS-设置后的具体表现" class="headerlink" title="allowTaint 和 useCORS 设置后的具体表现"></a>allowTaint 和 useCORS 设置后的具体表现</h3><table>
<thead>
<tr>
<th>allowTaint</th>
<th>useCORS</th>
<th>存在跨域资源时调用 <code>toDataURL</code> 时的表现</th>
</tr>
</thead>
<tbody><tr>
<td>false</td>
<td>false</td>
<td>控制台不会报错，但是输出的图像上跨域图片的位置为空白</td>
</tr>
<tr>
<td>true</td>
<td>false</td>
<td>控制台会报画布被污染的错误，html2canvas Promise 会走到 catch</td>
</tr>
<tr>
<td>true</td>
<td>true</td>
<td>将图片的 crossorigin 设置为 anonymous 后，如果服务器允许跨域，则图片正常被渲染</td>
</tr>
<tr>
<td>false</td>
<td>true</td>
<td>当 <code>allowTaint</code> 为 <code>false</code> 时，但是开启了 <code>useCORS</code>,也会加载跨域图片，表现与上面一致</td>
</tr>
</tbody></table>
<h1 id="3-受访问的服务器必须支持-CORS"><a href="#3-受访问的服务器必须支持-CORS" class="headerlink" title="3. 受访问的服务器必须支持 CORS"></a>3. 受访问的服务器必须支持 CORS</h1><p>如果请求的资源不支持返回跨域头，那么无论 html2canvas 如何配置，画布上都无法渲染出图片，控制台也会输出 CORS 的错误。</p>
<p>以百度云的对象存储 BOS 为例，创建 bucket 后可以在『配置管理』的『跨域访问CORS配置』中对跨域头进行配置：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/2bcec13c6f822e1eca9c7c4b448d578f.png" alt=""></p>
<p>此外如果启用了 CDN，也需要检查 『CDN 详情』- 『访问控制』-『跨域访问配置』中是否也允许了跨域：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403271959966.png" alt=""></p>
<p>配置了跨域访问后，如果能够发起一个跨域请求，那么响应头中应该存在 CORS 的相关字段：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403272002517.png" alt=""></p>
<h1 id="4-为-img-标签添加-crossorigin-属性"><a href="#4-为-img-标签添加-crossorigin-属性" class="headerlink" title="4. 为 img 标签添加  crossorigin 属性"></a>4. 为 img 标签添加  crossorigin 属性</h1><p>在解决方案的第3条『为 img 标签添加 <code>crossorigin=&quot;anonymous&quot;</code> 属性』，那么接下来我们就来解释以下这个行为发生了什么，以及为什么要这么做。</p>
<h3 id="corssorigin-”anonymous”-做了什么"><a href="#corssorigin-”anonymous”-做了什么" class="headerlink" title="corssorigin=”anonymous” 做了什么"></a>corssorigin=”anonymous” 做了什么</h3><p>当我们不添加这个属性时，发送的图片请求为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://esunr-webapp.cdn.bcebos.com/express-vue-template/playground/mountain.webp?freshKey=1711520456453&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;accept-language: zh-CN,zh;q=0.9&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;referer: http://172.24.136.200:5173/&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua: &quot;Google Chrome&quot;;v=&quot;123&quot;, &quot;Not:A-Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;123&quot;&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-mobile: ?0&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-platform: &quot;macOS&quot;&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-dest: image&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-mode: no-cors&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-site: cross-site&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36&#x27;</span></span><br></pre></td></tr></table></figure>

<p>添加了这个属性后发送的图片请求为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&#x27;https://esunr-webapp.cdn.bcebos.com/express-vue-template/playground/mountain.webp?freshKey=1711520795407&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;accept-language: zh-CN,zh;q=0.9&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;origin: http://172.24.136.200:5173&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;referer: http://172.24.136.200:5173/&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua: &quot;Google Chrome&quot;;v=&quot;123&quot;, &quot;Not:A-Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;123&quot;&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-mobile: ?0&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-ch-ua-platform: &quot;macOS&quot;&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-dest: image&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-mode: cors&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;sec-fetch-site: cross-site&#x27;</span> \</span><br><span class="line">  -H <span class="string">&#x27;user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36&#x27;</span></span><br></pre></td></tr></table></figure>

<p>将请求进行 Diff：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+ &#x27;origin: http://172.24.136.200:5173&#x27;</span></span><br><span class="line"><span class="deletion">- &#x27;sec-fetch-mode: no-cors&#x27;</span></span><br><span class="line"><span class="addition">+ &#x27;sec-fetch-mode: cors&#x27;</span></span><br></pre></td></tr></table></figure>

<p>发现添加 <code>crossorigin=&quot;anonymous&quot;</code> 属性后会添加一个 <code>origin</code> 与 <code>sec-fetch-mode</code> 的请求头，来告诉服务端获取的是一个跨域资源，当 BOS 接收到这个请求头后，会将响应的 <code>Access-Control-Allow-Origin</code> 字段设置为与 <code>origin</code> 同值。换句话说，<code>origin</code> 字段决定了 BOS 返回资源的 <code>Access-Control-Allow-Origin</code> 字段的值，<strong>如果请求头中没有 <code>origin</code> 字段，BOS 会返回一个错误的、被 CDN 缓存的，或者没有 <code>Access-Control-Allow-Origin</code> 响应头的响应</strong>。我们也都应知道，<code>Access-Control-Allow-Origin</code> 只有匹配当前域时，CORS 策略才会通过，否则跨域资源就会加载失败。</p>
<h3 id="为什么要设置-corssorigin-”anonymous”"><a href="#为什么要设置-corssorigin-”anonymous”" class="headerlink" title="为什么要设置 corssorigin=”anonymous”"></a>为什么要设置 corssorigin=”anonymous”</h3><p>那接下来我们来解释以下为什么在 img 标签中添加这个属性，其与浏览器的本地缓存是相关的。</p>
<p>假设我们没有设置这个属性，那么浏览器发起图片请求时，返回的图片是一个不带 CORS 相关响应头的资源，浏览器收到这个图片请求后便会将这个资源缓存在本地。当我们调用 html2canvas 时，其会加载相同的资源，那么再加载这张跨域图片后便是从浏览器缓存中取了这个没有 CORS 相关响应头的资源，那这就会导致将图片加载在 Canvas 上时出现 CORS 错误，如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403272026051.png" alt=""></p>
<p>浏览器整体的请求流程图如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403272040393.png" alt=""></p>
<p>当为 img 标签添加了 <code>crossorigin=&quot;anonymous&quot;</code> 属性后，浏览器在加载 HTML 中的图片时便会去请求一个携带了 CORS 相关响应头的图片，那么浏览器缓存的图片资源也就是带了跨域头的。那么后面调用 html2canvas 在离屏 canvas 中加载图片时，获取的缓存图片就是符合规格的了，那么就不会出现 CORS 错误了。流程图如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403272059883.png" alt=""></p>
<h1 id="5-来自其他页面的缓存"><a href="#5-来自其他页面的缓存" class="headerlink" title="5. 来自其他页面的缓存"></a>5. 来自其他页面的缓存</h1><p>在上一章节中，我们解释了设置 <code>crossorigin=&quot;anonymous&quot;</code> 是为了防止当前页面缓存一个没有 CORS 相关响应头的图片资源，在大多数情况下已经可以正常工作了。但当我们在其他页面页面或域加载了相同的图片资源时，他们所创建的缓存还是会影响到 html2canvas 的图片渲染的，这点需要特别注意。</p>
<h3 id="来自同站点的图片缓存"><a href="#来自同站点的图片缓存" class="headerlink" title="来自同站点的图片缓存"></a>来自同站点的图片缓存</h3><p>拿具体的示例来说，假如同一张图片出现在了当前网站的其他页面，但是使用该张图片的 img 标签未添加 <code>corssorigin</code> 属性，那么浏览器又会缓存一个没有 CORS 相关响应头的图片资源，导致 html2canvas 的图片渲染失败，同时网站内其他使用了相同图片并为 img 添加了 <code>corssorigin</code>  属性位置的图片也会加载失败，流程图如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281410292.png" alt=""></p>
<h3 id="来自同域的缓存"><a href="#来自同域的缓存" class="headerlink" title="来自同域的缓存"></a>来自同域的缓存</h3><p>此外还有一种情况需要额外注意，在浏览器缓存中，<strong>相同一级域名下的图片缓存，在子域名之间是会互相复用的</strong>，比如在域名 <code>local.baidu.com</code> 访问了图片 <code>mountain.webp</code>，那么在域名 <code>local2.baidu.com</code> 下访问相同的图片 <code>mountain.webp</code> 时，就会去获取第一次访问 <code>local.baidu.com</code> 时创建的缓存，即使两个域名的 img 标签都添加了 <code>corssorigin</code> 属性，但拿到的缓存图片响应头中的 <code>Access-Control-Allow-Origin</code> 是错误的，就仍然会造成 CORS 错误，流程图如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281653329.png" alt=""></p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p><strong>方案一：</strong></p>
<p>如果想要避免同站点缓存一张没有 CORS 响应头的资源，那么就要为所有 html2canvas 调用到的图片，在其同站点任何位置的 img 标签都添加上 <code>corssorigin</code> 属性，那这样自然就不会缓存错误的图片资源了，但这其实也并不算很严谨，因为你不知道这种行为什么时候就会被破坏。</p>
<p><strong>方案二：</strong></p>
<p>如果确实会遇到来自同域的缓存，方案一就不适用了，我们可以尝试是否能让服务端返回的图片资源，在遇到跨域请求时始终携带 <code>Access-Control-Allow-Origin: *</code> 的响应头，这样即使使用了其他域的缓存资源，由于其缓存的 <code>Access-Control-Allow-Origin</code> 值为通配符 <code>*</code>，那么在当前站点仍符合 CORS 策略，可以被正常加载。</p>
<p>以 BOS 为示例，在『配置管理』-『跨域访问CORS配置』中，默认的值为 <code>https://* http://*</code>，这代表 BOS 如果遇到跨域请求，会将 <code>Access-Control-Allow-Origin</code> 动态设置为请求头 <code>origin</code> 字段的值。我们需要将其改为 <code>*</code> 后保存，这样 BOS 在收到跨域请求时就不会进行判断，而是恒返回一个 <code>*</code>。</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281545753.png" alt=""></p>
<p>配置完成后请求图片：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281550019.png" alt=""></p>
<p>但是这样我们仍要保证站点内所有 html2canvas 调用的图片都得是跨域请求（也就是所有 img 标签都得有 <code>crossorigin</code> 属性），但是如果使用了 CDN 便可避免这一问题。CDN 支持自定义响应头，那么我们只要在 CDN 上添加 <code>Access-Control-Allow-Origin: *</code> 的响应头即可无论是否是跨域请求，都会携带该响应头，因此浏览器中缓存的资源始终都是合法的跨域资源，那么接下来 html2canvas 的操作便没有任何问题了，具体设置入口在 CDN 管理面板中，设置方式如下：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281553149.png" alt=""></p>
<p><strong>方案三：</strong></p>
<p>如果我们在已有的项目中实在不好去变动 Bucket 的设置，那我们为了保证 html2canvas 渲染不出错，就只能强行让 html2canvas 获取的图片不使用缓存，也就是每次访问的都是一张新图片。为了避免使用缓存，可以在图片的 src 后面追加一个时间戳作为 query，如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;`https://xxx/mountain.webp?timestamp=$&#123;new Date().valueOf()&#125;`&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>但这样的话，浏览器的图片缓存机制就会失效，并且如果使用了 CDN，每次请求都会触发回源，出于性能表现上是不太推荐这样做的。</p>
<p><strong>也许还有一种解决方案？</strong></p>
<p>html2canvas 上还存在一个配置项 <code>onclone</code>，表示在克隆 DOM 进行渲染时调用的函数，其本质是用于在不修改原始 DOM 的状态下对在 Canvas 上渲染的内容进行修改。那么我们就可以尝试是否能在正常的页面上请求不跨域的图片，然后在 <code>onclone</code> 函数中请求跨域图片，同时修改图片的 src 为其后缀一个时间戳，让其渲染在 Canvas 上时不使用缓存，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">html2canvas</span>(renderAreaRef.<span class="property">value</span>, &#123;</span><br><span class="line">  <span class="attr">allowTaint</span>: html2canvasOptions.<span class="property">allowTaint</span>,</span><br><span class="line">  <span class="attr">useCORS</span>: html2canvasOptions.<span class="property">useCORS</span>,</span><br><span class="line">  <span class="attr">onclone</span>: <span class="function">(<span class="params">doc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> images = doc.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    images.<span class="title function_">forEach</span>(<span class="function">(<span class="params">img</span>) =&gt;</span> &#123;</span><br><span class="line">      img.<span class="title function_">setAttribute</span>(<span class="string">&#x27;crossorigin&#x27;</span>, <span class="string">&#x27;anonymous&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> imgSrc = img.<span class="title function_">getAttribute</span>(<span class="string">&#x27;src&#x27;</span>);</span><br><span class="line">      img.<span class="title function_">setAttribute</span>(<span class="string">&#x27;src&#x27;</span>, <span class="string">`<span class="subst">$&#123;imgSrc&#125;</span>?timestamp=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">canvas</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> img = canvas.<span class="title function_">toDataURL</span>(<span class="string">&#x27;image/png&#x27;</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 导出图片</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;生成图片失败，查看控制台错误&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>但是经过尝试后，Canvas 上会绘制出来一张空白图片，因此这个方案可能暂时不适用：</p>
<p><img src="https://esunr-image-bed.oss-cn-beijing.aliyuncs.com/picgo/202403281647507.png" alt=""></p>
<p>但是如果使用 css 属性 <code>backgroundImage</code> 来加载图片却可以使用该方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">html2canvas</span>(renderAreaRef.<span class="property">value</span>, &#123;</span><br><span class="line">  <span class="attr">allowTaint</span>: html2canvasOptions.<span class="property">allowTaint</span>,</span><br><span class="line">  <span class="attr">useCORS</span>: html2canvasOptions.<span class="property">useCORS</span>,</span><br><span class="line">  <span class="attr">onclone</span>: <span class="function">(<span class="params">doc</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> images = doc.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.need-print-img&#x27;</span>);</span><br><span class="line">    images.<span class="title function_">forEach</span>(<span class="function">(<span class="params">img</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> backgroundImageUrl = (</span><br><span class="line">        img <span class="keyword">as</span> <span class="title class_">HTMLDivElement</span></span><br><span class="line">      ).<span class="property">style</span>.<span class="property">backgroundImage</span>.<span class="title function_">replace</span>(<span class="regexp">/url\(([&#x27;&quot;])?(.*?)\1\)/gi</span>, <span class="string">&#x27;$2&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> newImageUrl = <span class="string">`<span class="subst">$&#123;backgroundImageUrl&#125;</span>&amp;timestamp=<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().valueOf()&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 使用跨域请求预加载 image 图片</span></span><br><span class="line">      <span class="keyword">const</span> _img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span><br><span class="line">      _img.<span class="property">crossOrigin</span> = <span class="string">&#x27;anonymous&#x27;</span>;</span><br><span class="line">      _img.<span class="property">src</span> = newImageUrl;</span><br><span class="line"></span><br><span class="line">      (img <span class="keyword">as</span> <span class="title class_">HTMLDivElement</span>).<span class="property">style</span>.<span class="property">backgroundImage</span> = <span class="string">`url(<span class="subst">$&#123;_img.src&#125;</span>)`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">canvas</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> img = canvas.<span class="title function_">toDataURL</span>(<span class="string">&#x27;image/png&#x27;</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 导出图片</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ElMessage</span>.<span class="title function_">error</span>(<span class="string">&#x27;生成图片失败，查看控制台错误&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>但是使用 css 来展示图片既不合常规，也会导致 html2canvas 渲染模糊，总之还是不太推荐。</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JavaScript/">JavaScript</a><a class="post-meta__tags" href="/tags/HTML2Canvas/">HTML2Canvas</a><a class="post-meta__tags" href="/tags/%E8%B7%A8%E5%9F%9F/">跨域</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-62c7f2684e36ba34" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2024/04/3b3b66431fcb.html"><i class="fa fa-chevron-left">  </i><span>记一次 Webpack Vue 项目的异步引入失效</span></a></div><div class="next-post pull-right"><a href="/2024/03/d7594c17df2c.html"><span>面试中常见的排序算法总结</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://blog.esunr.site/2024/03/4ac0a05c2c2a.html';
  this.page.identifier = '2024/03/4ac0a05c2c2a.html';
  this.page.title = 'html2canvas 图片跨域问题的解决方案及其原理';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'esunr-blog' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://esunr-blog.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://esunr-webapp.cdn.bcebos.com/blog/background.png?x-bce-process=image/quality,q_80/format,f_auto)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2025 By EsunR</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>